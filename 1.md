
class ModernAttendanceSystem:
    def __init__(self, root, current_user, conn=None):
        self.root = root
        self.current_user = current_user
        self.root.title("نظام إدارة الدورات التخصصية")

        # تخزين الحجم الأصلي للخطوط قبل التعديل
        self.original_fonts = {
            "large_title": ("Tajawal", 24, "bold"),
            "title": ("Tajawal", 18, "bold"),
            "subtitle": ("Tajawal", 16, "bold"),
            "text": ("Tajawal", 12),
            "text_bold": ("Tajawal", 12, "bold"),
            "small": ("Tajawal", 10)
        }

        # تعريف الألوان
        self.colors = {
            "primary": "#1a73e8",
            "secondary": "#4285f4",
            "success": "#34a853",
            "danger": "#ea4335",
            "warning": "#fbbc05",
            "light": "#f0f4f8",
            "dark": "#202124",
            "present": "#34a853",
            "absent": "#ea4335",
            "late": "#fbbc05",
            "excused": "#4285f4",
            "not_started": "#FFA500",
            "excluded": "#9C27B0",
            "field_application": "#909090",
            "student_day": "#A9A9A9",
            "evening_remote": "#A0A0A0",
            "death_case": "#7E57C2",
            "hospital": "#26A69A",
        }

        # تحديد التخطيط الأمثل بناءً على حجم الشاشة
        self.determine_best_layout()

        # تعريف الخطوط بعد تحديد الحجم المناسب
        self.fonts = self.original_fonts.copy()

        self.style = ttk.Style(self.root)
        self.style.theme_use("clam")
        self.setup_styles()

        # ربط حدث تغيير حجم النافذة بدالة التكيف التلقائي
        self.root.bind('<Configure>', self.on_window_resize)

        self.tab_control = ttk.Notebook(self.root, style="Bold.TNotebook")
        self.tab_control.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        if conn:
            self.conn = conn
        else:
            self.conn = sqlite3.connect("attendance.db")

        self.create_tables()
        self.create_indexes()

        self.today = datetime.datetime.now().strftime("%Y-%m-%d")

        # تعريف متغيرات الإحصائيات
        self.total_students_var = tk.StringVar(value="0")
        self.present_students_var = tk.StringVar(value="0")
        self.absent_students_var = tk.StringVar(value="0")
        self.late_students_var = tk.StringVar(value="0")
        self.excused_students_var = tk.StringVar(value="0")
        self.not_started_students_var = tk.StringVar(value="0")
        self.field_application_var = tk.StringVar(value="0")
        self.student_day_var = tk.StringVar(value="0")
        self.evening_remote_var = tk.StringVar(value="0")
        self.attendance_rate_var = tk.StringVar(value="0%")
        self.death_case_var = tk.StringVar(value="0")
        self.hospital_var = tk.StringVar(value="0")

        # تخزين إشارات لبطاقات الإحصائيات للتحكم فيها لاحقًا
        self.stats_cards = []

        self.create_header()

        self.attendance_tab = tk.Frame(self.tab_control, bg=self.colors["light"])
        self.tab_control.add(self.attendance_tab, text="سجل الحضور")

        self.attendance_log_tab = tk.Frame(self.tab_control, bg=self.colors["light"])
        self.tab_control.add(self.attendance_log_tab, text="استعراض الحضور")

        self.students_tab = tk.Frame(self.tab_control, bg=self.colors["light"])
        self.tab_control.add(self.students_tab, text="إدارة المتدربين")

        # إعداد قاعدة البيانات
        if conn:
            self.conn = conn
        else:
            # فتح الاتصال باستخدام خيارات تحسين الأداء
            self.conn = sqlite3.connect("attendance.db", isolation_level=None)

            # تحسين أداء قاعدة البيانات
            self.conn.execute("PRAGMA journal_mode = WAL")  # استخدام وضع WAL للتخزين
            self.conn.execute("PRAGMA synchronous = NORMAL")  # تقليل وقت الانتظار للكتابة
            self.conn.execute("PRAGMA cache_size = -20000")  # استخدام ذاكرة تخزين مؤقت أكبر (حوالي 20 ميجابايت)
            self.conn.execute("PRAGMA temp_store = MEMORY")  # استخدام الذاكرة للتخزين المؤقت

        # إنشاء وتحسين الجداول والفهارس
        self.create_tables()
        self.create_indexes()  # دالة جديدة تمت إضافتها

        if self.current_user["permissions"]["is_admin"]:
            self.users_tab = tk.Frame(self.tab_control, bg=self.colors["light"])
            self.tab_control.add(self.users_tab, text="إدارة المستخدمين")
            self.setup_users_tab()

        self.setup_attendance_tab()
        self.setup_attendance_log_tab()
        self.setup_students_tab()

        self.status_bar = tk.Label(
            self.root,
            text=f"مرحبًا {self.current_user['full_name']} (مستخدم: {self.current_user['username']})",
            font=self.fonts["small"], bg=self.colors["primary"], fg="white", pady=5
        )
        self.status_bar.pack(side=tk.BOTTOM, fill=tk.X)

        self.archive_manager = ArchiveManager(self.root, self, self.colors, self.fonts)

        # في class AttendanceApp, في دالة __init__

        # إضافة تبويب الأرشيف
        self.archive_tab = tk.Frame(self.tab_control, bg=self.colors["light"])
        self.tab_control.add(self.archive_tab, text="أرشيف الدورات")
        self.setup_archive_tab()

        # إضافة تبويب مراقبة الغياب
        add_absence_monitoring_icon(self)

        # إضافة متغيرات تتبع النشاط لتسجيل الخروج التلقائي - الجزء الجديد
        self.last_activity_time = time.time()

        # إضافة متغيرات تتبع النشاط لتسجيل الخروج التلقائي - الجزء الجديد
        self.last_activity_time = time.time()
        self.inactivity_timeout = 600  # 30 ثانية للتجربة (يمكن تغييرها إلى 1200 للإعداد النهائي - 20 دقيقة)
        self.activity_check_id = None

        # ربط حركات المستخدم بتحديث وقت النشاط - الجزء الجديد
        self.root.bind("<Motion>", self.reset_activity_timer)
        self.root.bind("<Button-1>", self.reset_activity_timer)
        self.root.bind("<ButtonRelease-1>", self.reset_activity_timer)
        self.root.bind("<Key>", self.reset_activity_timer)

        # ربط دالة إغلاق النافذة - الجزء الجديد
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)

        # إضافة متغيرات لتتبع آخر عمليات التسجيل في الجلسة الحالية
        self.session_attendance_history = []  # قائمة لحفظ معرفات آخر التسجيلات الفردية
        self.session_course_attendance_history = []  # قائمة لحفظ تسجيلات الدورات الكاملة

        # تحديث واجهة البرنامج
        self.update_students_tree()
        self.update_statistics()
        self.update_attendance_display()

        # تطبيق التخطيط المناسب بعد إنشاء كل العناصر
        if self.screen_info["is_small_screen"]:
            self.apply_compact_layout()
        else:
            self.apply_expanded_layout()

        # بدء فحص النشاط - الجزء الجديد
        self.check_inactivity()

    def determine_best_layout(self):
        """تحديد التخطيط الأمثل بناءً على إعدادات الشاشة"""
        screen_width = self.root.winfo_screenwidth()
        screen_height = self.root.winfo_screenheight()

        # حساب حجم النافذة المناسب (90% من حجم الشاشة مع حد أقصى)
        window_width = min(int(screen_width * 0.9), 1400)
        window_height = min(int(screen_height * 0.9), 800)

        # توسيط النافذة
        x = (screen_width - window_width) // 2
        y = (screen_height - window_height) // 2

        # تعيين حجم وموقع النافذة
        self.root.geometry(f"{window_width}x{window_height}+{x}+{y}")

        # تعيين الحد الأدنى لحجم النافذة
        self.root.minsize(800, 600)

        # حفظ معلومات الشاشة لاستخدامها لاحقاً
        self.screen_info = {
            "screen_width": screen_width,
            "screen_height": screen_height,
            "window_width": window_width,
            "window_height": window_height,
            "is_small_screen": screen_width < 1200,
            "is_high_dpi": screen_width > 2000,
            "scale_factor": min(window_width / 1366, window_height / 768)  # عامل القياس النسبي
        }

        # تعديل أحجام الخطوط بناءً على عامل القياس إذا كانت شاشة عالية الدقة
        if self.screen_info["is_high_dpi"]:
            self.adjust_font_sizes(self.screen_info["scale_factor"])

    def setup_styles(self):
        """إعداد أنماط العناصر الرسومية"""
        self.style = ttk.Style()  # ✅ ضروري تعريف الكائن قبل الاستخدام

        self.style.configure("Bold.TNotebook.Tab", font=self.fonts["subtitle"])
        self.style.configure(
            "Bold.Treeview",
            background=self.colors["light"],
            foreground=self.colors["dark"],
            rowheight=30,
            fieldbackground=self.colors["light"],
            font=self.fonts["text_bold"]
        )
        self.style.configure(
            "Bold.Treeview.Heading",
            font=self.fonts["text_bold"],
            background=self.colors["primary"],
            foreground="white"
        )
        self.style.map('Bold.Treeview', background=[('selected', self.colors["primary"])])

        self.style.configure(
            "Profile.Treeview",
            background=self.colors["light"],
            foreground=self.colors["dark"],
            rowheight=32,
            fieldbackground=self.colors["light"],
            font=self.fonts["text_bold"]
        )
        self.style.configure(
            "Profile.Treeview.Heading",
            font=self.fonts["subtitle"],
            background=self.colors["primary"],
            foreground="white"
        )

    def on_window_resize(self, event=None):
        """تستجيب لتغيير حجم النافذة وتعدل العناصر تلقائياً"""
        # تجاهل الأحداث الصغيرة جدًا لتحسين الأداء
        if hasattr(self, 'last_width') and hasattr(self, 'last_height'):
            width_diff = abs(self.root.winfo_width() - self.last_width)
            height_diff = abs(self.root.winfo_height() - self.last_height)
            if width_diff < 10 and height_diff < 10:
                return

        # تخزين الحجم الحالي
        self.last_width = self.root.winfo_width()
        self.last_height = self.root.winfo_height()

        # تحديث معلومات الشاشة
        self.screen_info["window_width"] = self.last_width
        self.screen_info["window_height"] = self.last_height
        self.screen_info["is_small_screen"] = self.last_width < 1200

        # تعديل عرض الأعمدة في الجداول
        self.adjust_column_widths()

        # تعديل حجم النصوص في علامات التبويب
        self.adjust_tab_text()

        # تطبيق التخطيط المناسب
        if self.screen_info["is_small_screen"]:
            self.apply_compact_layout()
        else:
            self.apply_expanded_layout()

    def adjust_font_sizes(self, scale_factor):
        """تعديل أحجام الخطوط بناءً على عامل القياس"""
        # تحديث قيم الخطوط بناءً على عامل القياس
        self.fonts = {
            "large_title": ("Tajawal", int(self.original_fonts["large_title"][1] * scale_factor), "bold"),
            "title": ("Tajawal", int(self.original_fonts["title"][1] * scale_factor), "bold"),
            "subtitle": ("Tajawal", int(self.original_fonts["subtitle"][1] * scale_factor), "bold"),
            "text": ("Tajawal", int(self.original_fonts["text"][1] * scale_factor)),
            "text_bold": ("Tajawal", int(self.original_fonts["text_bold"][1] * scale_factor), "bold"),
            "small": ("Tajawal", int(self.original_fonts["small"][1] * scale_factor))
        }

        # تحديث أنماط العناصر الرسومية
        self.setup_styles()

    def adjust_column_widths(self):
        """تعديل عرض الأعمدة في جداول العرض بناءً على حجم النافذة"""
        try:
            # تعديل جدول سجل الحضور
            if hasattr(self, 'attendance_tree'):
                available_width = self.attendance_tree.winfo_width()
                if available_width > 50:  # تأكد من تهيئة العنصر
                    # تحديد النسب المئوية للأعمدة - زيادة نسبة عمود الاسم
                    col_ratios = [0.12, 0.28, 0.10, 0.12, 0.10, 0.10, 0.10, 0.08]  # زيادة عرض الاسم من 0.20 إلى 0.28

                    # حساب العرض الفعلي لكل عمود
                    for i, ratio in enumerate(col_ratios):
                        width = int(available_width * ratio)
                        if width > 10:  # تجنب القيم السالبة أو الصغيرة جدًا
                            self.attendance_tree.column(self.attendance_tree["columns"][i], width=width)

            # تعديل جدول المتدربين
            if hasattr(self, 'students_tree'):
                available_width = self.students_tree.winfo_width()
                if available_width > 50:
                    col_ratios = [0.15, 0.35, 0.15, 0.15, 0.15, 0.05]  # زيادة عرض الاسم من 0.30 إلى 0.35
                    for i, ratio in enumerate(col_ratios):
                        width = int(available_width * ratio)
                        if width > 10:
                            self.students_tree.column(self.students_tree["columns"][i], width=width)
        except Exception as e:
            print(f"خطأ عند تعديل عرض الأعمدة: {str(e)}")

    def adjust_tab_text(self):
        """تعديل نصوص علامات التبويب حسب المساحة المتاحة"""
        window_width = self.root.winfo_width()

        # على الشاشات الصغيرة، استخدم أسماء مختصرة
        if window_width < 800:
            self.tab_control.tab(0, text="الحضور")
            self.tab_control.tab(1, text="السجل")
            self.tab_control.tab(2, text="المتدربين")
            if self.current_user["permissions"]["is_admin"]:
                self.tab_control.tab(3, text="المستخدمين")
                self.tab_control.tab(4, text="الأرشيف")
            else:
                self.tab_control.tab(3, text="الأرشيف")
        else:
            # على الشاشات الكبيرة، استخدم الأسماء الكاملة
            self.tab_control.tab(0, text="سجل الحضور")
            self.tab_control.tab(1, text="استعراض الحضور")
            self.tab_control.tab(2, text="إدارة المتدربين")
            if self.current_user["permissions"]["is_admin"]:
                self.tab_control.tab(3, text="إدارة المستخدمين")
                self.tab_control.tab(4, text="أرشيف الدورات")
            else:
                self.tab_control.tab(3, text="أرشيف الدورات")

    def apply_compact_layout(self):
        """تطبيق التخطيط المضغوط للشاشات الصغيرة"""
        # تخزين وضع التخطيط الحالي
        self.current_layout = "compact"

        # تنظيم الإحصائيات في عمود واحد
        self.organize_stats_in_one_column()

        # تعديل عدد الأزرار المعروضة
        self.organize_buttons_for_small_screen()

    def apply_expanded_layout(self):
        """تطبيق التخطيط الموسع للشاشات الكبيرة"""
        # تخزين وضع التخطيط الحالي
        self.current_layout = "expanded"

        # تنظيم الإحصائيات في صفين
        self.organize_stats_in_two_rows()

        # عرض كامل للأزرار
        self.show_all_buttons()

    def organize_stats_in_one_column(self):
        """تنظيم بطاقات الإحصائيات في عمود واحد للشاشات الصغيرة"""
        # التنفيذ فقط إذا كان التخطيط الحالي ليس مضغوطًا
        if hasattr(self, 'current_layout') and self.current_layout == "compact":
            return

        if hasattr(self, 'stats_cards') and self.stats_cards:
            stats_frame = self.find_parent_frame(self.stats_cards[0])

            if stats_frame:
                # إزالة الصفوف القديمة
                for child in stats_frame.winfo_children():
                    if child != self.stats_cards[0].master:  # حفظ الإطار الرئيسي
                        child.destroy()

                # إنشاء إطار واحد للعمود
                column_frame = tk.Frame(stats_frame, bg=self.colors["light"])
                column_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)

                # إعادة تنظيم بطاقات الإحصائيات
                for i, card in enumerate(self.stats_cards):
                    card.pack_forget()  # إزالة من التخطيط الحالي
                    card.pack(in_=column_frame, fill=tk.X, padx=5, pady=2)  # إعادة تنظيم في العمود

    def organize_stats_in_two_rows(self):
        """تنظيم بطاقات الإحصائيات في صفين للشاشات الكبيرة"""
        # التنفيذ فقط إذا كان التخطيط الحالي ليس موسعًا
        if hasattr(self, 'current_layout') and self.current_layout == "expanded":
            return

        if hasattr(self, 'stats_cards') and self.stats_cards:
            stats_frame = self.find_parent_frame(self.stats_cards[0])

            if stats_frame:
                # إزالة العمود القديم
                for child in stats_frame.winfo_children():
                    child.destroy()

                # إنشاء إطارين للصفين
                top_counter_frame = tk.Frame(stats_frame, bg=self.colors["light"])
                top_counter_frame.pack(fill=tk.X, padx=5, pady=5)

                bottom_counter_frame = tk.Frame(stats_frame, bg=self.colors["light"])
                bottom_counter_frame.pack(fill=tk.X, padx=5, pady=5)

                # توزيع بطاقات الإحصائيات على الصفين
                half_count = len(self.stats_cards) // 2

                for i, card in enumerate(self.stats_cards):
                    card.pack_forget()  # إزالة من التخطيط الحالي

                    if i < half_count:
                        # الصف الأول
                        card.pack(in_=top_counter_frame, side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
                    else:
                        # الصف الثاني
                        card.pack(in_=bottom_counter_frame, side=tk.RIGHT, padx=5, fill=tk.X, expand=True)

    def find_parent_frame(self, widget):
        """العثور على إطار الأب لعنصر واجهة"""
        if widget is None:
            return None

        parent = widget.master
        while parent is not None:
            if isinstance(parent, tk.LabelFrame) and parent.cget("text") == "إحصائيات اليوم":
                return parent
            parent = parent.master

        return None

    def organize_buttons_for_small_screen(self):
        """تنظيم الأزرار للشاشات الصغيرة"""
        # تنفيذ فقط عند الضرورة
        if hasattr(self, 'current_layout') and self.current_layout == "compact":
            return

        # هنا يمكن تنفيذ تغييرات على تنظيم الأزرار
        # مثل إنشاء قائمة منسدلة لبعض الأزرار الأقل استخداماً
        # أو تصغير حجم الأزرار أو تقليل النص المعروض

        pass  # يمكن تنفيذ المزيد حسب الاحتياج

    def show_all_buttons(self):
        """عرض جميع الأزرار للشاشات الكبيرة"""
        # تنفيذ فقط عند الضرورة
        if hasattr(self, 'current_layout') and self.current_layout == "expanded":
            return

        # إعادة الأزرار إلى حالتها الطبيعية
        # مثل إظهار جميع الأزرار وإعادة النصوص الكاملة

        pass  # يمكن تنفيذ المزيد حسب الاحتياج

    def setup_users_tab(self):
        user_management_frame = tk.Frame(self.users_tab, bg=self.colors["light"])
        user_management_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        tk.Label(
            user_management_frame,
            text="إدارة مستخدمي النظام (محمي بكلمة مرور) - خاص بالمشرف",
            font=self.fonts["title"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=10
        ).pack(fill=tk.X)

        open_button = tk.Button(
            user_management_frame,
            text="فتح نافذة إدارة المستخدمين",
            font=self.fonts["text_bold"],
            bg=self.colors["secondary"],
            fg="white",
            padx=20, pady=10, bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=self.protected_open_user_management
        )
        open_button.pack(pady=50)

        # إضافة إطار للنسخ الاحتياطي
        backup_frame = tk.Frame(user_management_frame, bg=self.colors["light"], pady=20)
        backup_frame.pack(pady=20)

        tk.Label(
            backup_frame,
            text="إدارة النسخ الاحتياطية لقاعدة البيانات",
            font=self.fonts["text_bold"],
            bg=self.colors["light"],
            fg=self.colors["dark"]
        ).pack(pady=(0, 10))

        # إضافة أزرار النسخ الاحتياطي والاسترداد
        backup_btn = tk.Button(
            backup_frame,
            text="إنشاء نسخة احتياطية",
            font=self.fonts["text_bold"],
            bg=self.colors["primary"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=self.backup_database
        )
        backup_btn.pack(side=tk.LEFT, padx=5)

        restore_btn = tk.Button(
            backup_frame,
            text="استرداد نسخة احتياطية",
            font=self.fonts["text_bold"],
            bg=self.colors["warning"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=self.restore_database
        )
        restore_btn.pack(side=tk.LEFT, padx=5)

        optimize_db_btn = tk.Button(
            backup_frame,
            text="تحسين أداء قاعدة البيانات",
            font=self.fonts["text_bold"],
            bg=self.colors["secondary"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=self.optimize_database
        )
        optimize_db_btn.pack(side=tk.LEFT, padx=5)

        tk.Label(
            user_management_frame,
            text="لن يتم فتح نافذة إدارة المستخدمين إلا بعد إدخال كلمة مرور المشرف.",
            font=self.fonts["text"],
            bg=self.colors["light"],
            fg=self.colors["dark"],
            padx=10, pady=10, wraplength=700
        ).pack(fill=tk.X)

    def protected_open_user_management(self):
        if not self.current_user["permissions"]["is_admin"]:
            messagebox.showerror("خطأ", "لا تملك صلاحية!")
            return
        admin_pass = simpledialog.askstring("إدخال كلمة المرور", "أدخل كلمة المرور الخاصة بالمشرف:", show='*')
        if not admin_pass:
            return
        cur = self.conn.cursor()
        cur.execute("SELECT password FROM users WHERE username='admin'")
        row = cur.fetchone()
        if not row:
            messagebox.showerror("خطأ", "لا يوجد حساب مشرف رئيسي!")
            return
        admin_real_hash = row[0]
        hashed_input = hashlib.sha256(admin_pass.encode()).hexdigest()
        if hashed_input == admin_real_hash:
            UserManagement(self.root, self.conn, self.current_user, self.colors, self.fonts)
        else:
            messagebox.showerror("خطأ", "كلمة المرور غير صحيحة!")

    def create_tables(self):
        try:
            with self.conn:
                # جدول المتدربين
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS trainees (
                        national_id TEXT PRIMARY KEY,
                        name TEXT,
                        rank TEXT,
                        course TEXT,
                        phone TEXT,
                        is_excluded INTEGER DEFAULT 0,
                        exclusion_reason TEXT DEFAULT '',
                        excluded_date TEXT DEFAULT ''
                    )
                """)

                # جدول الحضور
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS attendance (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        national_id TEXT,
                        name TEXT,
                        rank TEXT,
                        course TEXT,
                        time TEXT,
                        date TEXT,
                        status TEXT,
                        original_status TEXT,
                        registered_by TEXT,
                        excuse_reason TEXT DEFAULT '',
                        updated_by TEXT,
                        updated_at TEXT,
                        modification_reason TEXT DEFAULT '',
                        receiver_name TEXT DEFAULT ''
                    )
                """)

                # جدول الفصول
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS course_sections (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        course_name TEXT NOT NULL,
                        section_name TEXT NOT NULL,
                        created_date TEXT,
                        UNIQUE(course_name, section_name)
                    )
                """)

                # جدول تسجيل المتدربين في الفصول
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS student_sections (
                        national_id TEXT NOT NULL,
                        course_name TEXT NOT NULL,
                        section_name TEXT NOT NULL,
                        assigned_date TEXT,
                        PRIMARY KEY (national_id, course_name),
                        FOREIGN KEY (national_id) REFERENCES trainees(national_id)
                    )
                """)

                # جدول معلومات الدورات
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS course_info (
                        course_name TEXT PRIMARY KEY,
                        start_day TEXT,
                        start_month TEXT,
                        start_year TEXT,
                        end_day TEXT,
                        end_month TEXT,
                        end_year TEXT,
                        end_date_system TEXT,
                        course_category TEXT,
                        created_date TEXT
                    )
                """)

                # جدول المخالفات المحدث بجميع الحقول الجديدة
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS student_violations (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        national_id TEXT,
                        violation_date TEXT,
                        violation_type TEXT,
                        description TEXT,
                        action_taken TEXT,
                        action_date TEXT,
                        recorded_by TEXT,
                        notes TEXT,
                        attachment_path TEXT,
                        behavior_deduction INTEGER DEFAULT 0,
                        custom_action TEXT DEFAULT '',
                        custom_violation_type TEXT DEFAULT '',
                        FOREIGN KEY (national_id) REFERENCES trainees(national_id)
                    )
                """)

                # جدول تسجيل التعديلات التاريخية
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS historical_edits_log (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        attendance_id INTEGER,
                        national_id TEXT,
                        student_name TEXT,
                        edit_date TEXT,
                        original_date TEXT,
                        old_status TEXT,
                        new_status TEXT,
                        edited_by TEXT,
                        edit_timestamp TEXT,
                        days_difference INTEGER,
                        FOREIGN KEY (attendance_id) REFERENCES attendance(id)
                    )
                """)

                # جدول المستخدمين
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS users (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        username TEXT UNIQUE,
                        password TEXT,
                        full_name TEXT,
                        created_date TEXT,
                        last_login TEXT,
                        is_active INTEGER DEFAULT 1
                    )
                """)

                # جدول صلاحيات المستخدمين
                self.conn.execute("""
                    CREATE TABLE IF NOT EXISTS user_permissions (
                        user_id INTEGER PRIMARY KEY,
                        can_edit_attendance INTEGER DEFAULT 1,
                        can_add_students INTEGER DEFAULT 1,
                        can_edit_students INTEGER DEFAULT 1,
                        can_delete_students INTEGER DEFAULT 0,
                        can_view_edit_history INTEGER DEFAULT 0,
                        can_reset_attendance INTEGER DEFAULT 0,
                        can_export_data INTEGER DEFAULT 1,
                        can_import_data INTEGER DEFAULT 0,
                        can_edit_old_attendance INTEGER DEFAULT 0,
                        is_admin INTEGER DEFAULT 0,
                        FOREIGN KEY (user_id) REFERENCES users(id)
                    )
                """)

                # التحقق من الأعمدة وإضافة المفقودة
                cursor = self.conn.cursor()

                # فحص وإضافة الأعمدة في جدول course_info
                cursor.execute("PRAGMA table_info(course_info)")
                columns = [column[1] for column in cursor.fetchall()]

                if "end_date_system" not in columns:
                    self.conn.execute("ALTER TABLE course_info ADD COLUMN end_date_system TEXT")
                if "course_category" not in columns:
                    self.conn.execute("ALTER TABLE course_info ADD COLUMN course_category TEXT")

                # فحص وإضافة أعمدة الاستبعاد للمتدربين
                cursor.execute("PRAGMA table_info(trainees)")
                columns = [column[1] for column in cursor.fetchall()]

                if "is_excluded" not in columns:
                    self.conn.execute("ALTER TABLE trainees ADD COLUMN is_excluded INTEGER DEFAULT 0")
                if "exclusion_reason" not in columns:
                    self.conn.execute("ALTER TABLE trainees ADD COLUMN exclusion_reason TEXT DEFAULT ''")
                if "excluded_date" not in columns:
                    self.conn.execute("ALTER TABLE trainees ADD COLUMN excluded_date TEXT DEFAULT ''")

                # فحص وإضافة الأعمدة المفقودة في جدول attendance
                cursor.execute("PRAGMA table_info(attendance)")
                columns = [column[1] for column in cursor.fetchall()]

                if "original_status" not in columns:
                    self.conn.execute("ALTER TABLE attendance ADD COLUMN original_status TEXT")
                if "updated_by" not in columns:
                    self.conn.execute("ALTER TABLE attendance ADD COLUMN updated_by TEXT")
                if "updated_at" not in columns:
                    self.conn.execute("ALTER TABLE attendance ADD COLUMN updated_at TEXT")
                if "modification_reason" not in columns:
                    self.conn.execute("ALTER TABLE attendance ADD COLUMN modification_reason TEXT DEFAULT ''")
                if "receiver_name" not in columns:
                    self.conn.execute("ALTER TABLE attendance ADD COLUMN receiver_name TEXT DEFAULT ''")
                if "excuse_reason" not in columns:
                    self.conn.execute("ALTER TABLE attendance ADD COLUMN excuse_reason TEXT DEFAULT ''")

                # فحص وإضافة الأعمدة الجديدة في جدول المخالفات
                cursor.execute("PRAGMA table_info(student_violations)")
                columns = [column[1] for column in cursor.fetchall()]

                if "behavior_deduction" not in columns:
                    self.conn.execute("ALTER TABLE student_violations ADD COLUMN behavior_deduction INTEGER DEFAULT 0")
                if "custom_action" not in columns:
                    self.conn.execute("ALTER TABLE student_violations ADD COLUMN custom_action TEXT DEFAULT ''")
                if "custom_violation_type" not in columns:
                    self.conn.execute("ALTER TABLE student_violations ADD COLUMN custom_violation_type TEXT DEFAULT ''")

                # فحص وإضافة العمود في جدول الصلاحيات
                cursor.execute("PRAGMA table_info(user_permissions)")
                columns = [column[1] for column in cursor.fetchall()]

                if "can_edit_old_attendance" not in columns:
                    self.conn.execute(
                        "ALTER TABLE user_permissions ADD COLUMN can_edit_old_attendance INTEGER DEFAULT 0")

                self.conn.commit()
                print("تم إنشاء/تحديث الجداول بنجاح")

        except Exception as e:
            messagebox.showerror("خطأ", f"حدث خطأ أثناء إنشاء/تعديل الجداول: {str(e)}")

    def create_indexes(self):
        """إنشاء فهارس لتحسين أداء قاعدة البيانات"""
        try:
            cursor = self.conn.cursor()

            # فهارس للمتدربين
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_trainees_course ON trainees (course)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_trainees_name ON trainees (name)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_trainees_excluded ON trainees (is_excluded)")

            # فهارس سجلات الحضور
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_attendance_national_id ON attendance (national_id)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_attendance_date ON attendance (date)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_attendance_status ON attendance (status)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_attendance_course ON attendance (course)")
            cursor.execute(
                "CREATE INDEX IF NOT EXISTS idx_attendance_date_national_id ON attendance (date, national_id)")

            # فهارس الفصول
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_sections_course ON course_sections (course_name)")
            cursor.execute(
                "CREATE INDEX IF NOT EXISTS idx_student_sections_national_id ON student_sections (national_id)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_student_sections_course ON student_sections (course_name)")

            self.conn.commit()
            print("تم إنشاء الفهارس بنجاح")
        except Exception as e:
            print(f"خطأ في إنشاء الفهارس: {str(e)}")

    def clean_deleted_courses(self):
        """تنظيف بيانات الدورات المحذوفة من جميع الجداول"""
        try:
            cursor = self.conn.cursor()

            # الحصول على قائمة الدورات الموجودة فعلياً في جدول المتدربين
            cursor.execute("""
                SELECT DISTINCT course 
                FROM trainees 
                WHERE course IS NOT NULL AND course != ''
            """)
            active_courses = [row[0] for row in cursor.fetchall()]

            if active_courses:
                # حذف بيانات الدورات غير الموجودة من جدول course_info
                cursor.execute("""
                    DELETE FROM course_info 
                    WHERE course_name NOT IN ({})
                    AND course_name IS NOT NULL
                """.format(','.join('?' * len(active_courses))), active_courses)
            else:
                # إذا لم تكن هناك دورات نشطة، احذف كل شيء من course_info
                cursor.execute("DELETE FROM course_info")

            # حذف بيانات الحضور للمتدربين غير الموجودين
            cursor.execute("""
                DELETE FROM attendance 
                WHERE national_id NOT IN (SELECT national_id FROM trainees)
            """)

            # حذف بيانات الفصول للدورات غير الموجودة
            if active_courses:
                cursor.execute("""
                    DELETE FROM course_sections 
                    WHERE course_name NOT IN ({})
                    AND course_name IS NOT NULL
                """.format(','.join('?' * len(active_courses))), active_courses)
            else:
                cursor.execute("DELETE FROM course_sections")

            self.conn.commit()

            messagebox.showinfo("نجاح", "تم تنظيف قاعدة البيانات من بقايا الدورات المحذوفة")

        except Exception as e:
            messagebox.showerror("خطأ", f"حدث خطأ أثناء تنظيف قاعدة البيانات: {str(e)}")

    def create_header(self):
        header_frame = tk.Frame(self.root, bg=self.colors["primary"], height=70)
        header_frame.pack(fill=tk.X)

        # منع الإطار من الانكماش
        header_frame.pack_propagate(False)

        # استخدام تخطيط أكثر مرونة للعناوين
        logo_container = tk.Frame(header_frame, bg=self.colors["primary"])
        logo_container.pack(fill=tk.BOTH, expand=True, padx=20, pady=15)

        logo_label = tk.Label(
            logo_container,
            text="قسم شؤون المدربين - نظام إدارة الدورات التخصصية",
            font=self.fonts["large_title"],
            bg=self.colors["primary"],
            fg="white"
        )
        logo_label.pack(side=tk.RIGHT)

        # إطار منفصل لمعلومات المستخدم
        user_frame = tk.Frame(logo_container, bg=self.colors["primary"])
        user_frame.pack(side=tk.LEFT)

        user_type = "مشرف" if self.current_user["permissions"]["is_admin"] else "مستخدم"
        user_label = tk.Label(
            user_frame,
            text=f"المستخدم: {self.current_user['full_name']} ({user_type})",
            font=self.fonts["text_bold"],
            bg=self.colors["primary"],
            fg="white"
        )
        user_label.pack(side=tk.LEFT)

        logout_btn = tk.Button(
            user_frame,
            text="تسجيل الخروج",
            font=self.fonts["text"],
            bg="#ff5252",
            fg="white",
            padx=10,
            pady=2,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.logout
        )
        logout_btn.pack(side=tk.LEFT, padx=15)

        # تعديل حجم العنوان للشاشات الصغيرة
        def adjust_header_for_screen_size(event=None):
            window_width = self.root.winfo_width()
            if window_width < 800:
                logo_label.config(text=" نظام إدارة الدورات التخصصية")
            else:
                logo_label.config(text="قسم شؤون المدربين -  نظام إدارة الدورات التخصصية")

        # ربط وظيفة تغيير الحجم بحدث تغيير حجم النافذة
        self.root.bind('<Configure>', adjust_header_for_screen_size)

    def logout(self):
        if messagebox.askyesnocancel("تسجيل الخروج", "هل تريد تسجيل الخروج؟"):
            # إلغاء جدولة فحص النشاط
            if self.activity_check_id:
                self.root.after_cancel(self.activity_check_id)

            self.root.destroy()
            root = tk.Tk()
            LoginSystem(root)
            root.mainloop()

    def on_closing(self):
        """التعامل مع إغلاق النافذة الرئيسية"""
        # إلغاء جدولة فحص النشاط
        if self.activity_check_id:
            self.root.after_cancel(self.activity_check_id)

        self.root.destroy()

    def reset_activity_timer(self, event=None):
        """تحديث وقت آخر نشاط للمستخدم"""
        self.last_activity_time = time.time()

    def check_inactivity(self):
        """فحص مدة عدم النشاط وتسجيل الخروج إذا تجاوزت الحد المسموح"""
        current_time = time.time()
        elapsed_time = current_time - self.last_activity_time

        # إذا تجاوز الوقت المنقضي الحد المسموح
        if elapsed_time >= self.inactivity_timeout:
            # عرض رسالة وتسجيل الخروج
            messagebox.showinfo("تسجيل الخروج التلقائي", "تم تسجيل خروجك تلقائياً بسبب عدم النشاط")
            self.force_logout()
            return

        # جدولة الفحص التالي كل ثانية
        self.activity_check_id = self.root.after(1000, self.check_inactivity)

    def force_logout(self):
        """تسجيل الخروج المباشر بدون تأكيد"""
        # إلغاء جدولة فحص النشاط
        if self.activity_check_id:
            self.root.after_cancel(self.activity_check_id)

        # تدمير النافذة الحالية وإعادة تشغيل شاشة تسجيل الدخول
        self.root.destroy()
        root = tk.Tk()
        LoginSystem(root)
        root.mainloop()

    def filter_attendance(self, event=None):
        selected_status = self.status_filter_var.get()
        if selected_status == "الكل":
            self.export_button.config(text="تصدير الكل")
            # إخفاء أدوات التحديد عند العرض الكلي
            if hasattr(self, 'selection_frame'):
                self.selection_frame.pack_forget()
        else:
            self.export_button.config(text=f"تصدير {selected_status}")

            # إظهار أدوات التحديد فقط عند اختيار "لم يباشر"
            if selected_status == "لم يباشر" and hasattr(self, 'selection_frame'):
                self.selection_frame.pack(fill=tk.X, padx=10, pady=5, before=self.attendance_tree)
            else:
                if hasattr(self, 'selection_frame'):
                    self.selection_frame.pack_forget()

        # مسح قائمة المتدربين المحددين
        self.selected_students = {}

        self.update_attendance_display()

    def on_tree_click(self, event):
        """التعامل مع النقر على الشجرة وخاصة عمود الـ checkbox"""
        # الحصول على العنصر الذي تم النقر عليه والعمود
        region = self.attendance_tree.identify_region(event.x, event.y)
        if region == "cell":
            column = self.attendance_tree.identify_column(event.x)
            item = self.attendance_tree.identify_row(event.y)

            # فقط إذا كان النقر على عمود الـ checkbox (العمود الأول)
            if column == "#1" and item:  # عمود الـ checkbox
                # تبديل حالة التحديد
                if item in self.selected_students:
                    self.selected_students.pop(item)
                    self.attendance_tree.item(item, values=self.update_checkbox_value(item, False))
                    self.attendance_tree.item(item, tags=self.get_item_tags(item, False))
                else:
                    self.selected_students[item] = True
                    self.attendance_tree.item(item, values=self.update_checkbox_value(item, True))
                    self.attendance_tree.item(item, tags=self.get_item_tags(item, True))

                # منع معالجة الحدث الافتراضية فقط للنقر على الـ checkbox
                return "break"

            # بالنسبة للنقر على الأعمدة الأخرى، نسمح بالسلوك الافتراضي للشجرة (مثل النقر المزدوج)

    def select_all_students(self):
        """تحديد جميع المتدربين الظاهرين في القائمة"""
        for item in self.attendance_tree.get_children():
            self.selected_students[item] = True
            self.attendance_tree.item(item, values=self.update_checkbox_value(item, True))
            self.attendance_tree.item(item, tags=self.get_item_tags(item, True))

    def clear_all_selection(self):
        """إلغاء تحديد جميع المتدربين"""
        for item in self.attendance_tree.get_children():
            if item in self.selected_students:
                self.selected_students.pop(item)
            self.attendance_tree.item(item, values=self.update_checkbox_value(item, False))
            self.attendance_tree.item(item, tags=self.get_item_tags(item, False))

    def update_checkbox_value(self, item, checked):
        """تحديث قيمة الـ checkbox في صف معين"""
        values = list(self.attendance_tree.item(item, "values"))
        values[0] = "✓" if checked else ""
        return values

    def get_item_tags(self, item, is_checked):
        """الحصول على الوسوم للصف بناءً على حالة التحديد والنوع"""
        current_tags = list(self.attendance_tree.item(item, "tags"))
        if "checked" in current_tags and not is_checked:
            current_tags.remove("checked")
        elif "checked" not in current_tags and is_checked:
            current_tags.append("checked")
        return current_tags

    def get_all_absences_count(self, national_id):
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT COUNT(*) 
            FROM attendance
            WHERE national_id=? AND status='غائب'
        """, (national_id,))
        return cursor.fetchone()[0]

    def get_all_late_count(self, national_id):
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT COUNT(*) 
            FROM attendance
            WHERE national_id=? AND status='متأخر'
        """, (national_id,))
        return cursor.fetchone()[0]

    def get_all_excused_count(self, national_id):
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT COUNT(*) 
            FROM attendance
            WHERE national_id=? AND status='غائب بعذر'
        """, (national_id,))
        return cursor.fetchone()[0]

    def setup_attendance_tab(self):
        self.setup_stats_panel()
        self.setup_individual_attendance()
        self.setup_bulk_attendance()

    def setup_stats_panel(self):
        stats_frame = tk.LabelFrame(
            self.attendance_tab,
            text="إحصائيات اليوم",
            font=self.fonts["subtitle"],
            bg=self.colors["light"],
            fg=self.colors["dark"],
            padx=10, pady=10
        )
        stats_frame.pack(fill=tk.X, padx=10, pady=5)

        # إنشاء إطارين للصفين
        top_counter_frame = tk.Frame(stats_frame, bg=self.colors["light"])
        top_counter_frame.pack(fill=tk.X, padx=5, pady=5)

        bottom_counter_frame = tk.Frame(stats_frame, bg=self.colors["light"])
        bottom_counter_frame.pack(fill=tk.X, padx=5, pady=5)

        # مسح قائمة البطاقات
        self.stats_cards = []

        # الصف الأول من الإحصائيات
        card1 = self.create_stat_card(top_counter_frame, "إجمالي المتدربين", self.total_students_var,
                                      self.colors["primary"])
        card1.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card1)

        card2 = self.create_stat_card(top_counter_frame, "الحاضرون", self.present_students_var, self.colors["success"])
        card2.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card2)

        card3 = self.create_stat_card(top_counter_frame, "المتأخرون", self.late_students_var, self.colors["late"])
        card3.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card3)

        card4 = self.create_stat_card(top_counter_frame, "الغائبون", self.absent_students_var, self.colors["danger"])
        card4.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card4)

        card5 = self.create_stat_card(top_counter_frame, "غائب بعذر", self.excused_students_var, self.colors["excused"])
        card5.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card5)

        card6 = self.create_stat_card(top_counter_frame, "لم يباشر", self.not_started_students_var,
                                      self.colors["not_started"])
        card6.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card6)

        # الصف الثاني من الإحصائيات
        card7 = self.create_stat_card(bottom_counter_frame, "تطبيق ميداني", self.field_application_var,
                                      self.colors["field_application"])
        card7.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card7)

        card8 = self.create_stat_card(bottom_counter_frame, "يوم طالب", self.student_day_var,
                                      self.colors["student_day"])
        card8.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card8)

        card9 = self.create_stat_card(bottom_counter_frame, "مسائية / عن بعد", self.evening_remote_var,
                                      self.colors["evening_remote"])
        card9.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card9)

        card10 = self.create_stat_card(bottom_counter_frame, "حالة وفاة", self.death_case_var,
                                       self.colors["death_case"])
        card10.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card10)

        card11 = self.create_stat_card(bottom_counter_frame, "منوم", self.hospital_var, self.colors["hospital"])
        card11.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card11)

        card12 = self.create_stat_card(bottom_counter_frame, "نسبة الحضور", self.attendance_rate_var,
                                       self.colors["warning"])
        card12.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        self.stats_cards.append(card12)

    def create_stat_card(self, parent, title, variable, color):
        card = tk.Frame(parent, bg=self.colors["light"], bd=1, relief=tk.RIDGE)

        # استخدام نسب مرنة لحجم العنصر
        title_label = tk.Label(card, text=title, font=self.fonts["text_bold"], bg=color, fg="white", padx=5, pady=5)
        title_label.pack(fill=tk.X)

        value_label = tk.Label(card, textvariable=variable, font=self.fonts["title"], bg=self.colors["light"], pady=10)
        value_label.pack(fill=tk.X)

        return card

    def setup_individual_attendance(self):
        """إعادة تصميم إطار تسجيل الحضور بتنظيم أفضل وأكثر راحة للعين"""
        attendance_frame = tk.LabelFrame(
            self.attendance_tab,
            text="تسجيل الحضور",
            font=self.fonts["subtitle"],
            bg=self.colors["light"],
            fg=self.colors["dark"],
            padx=15,
            pady=15
        )
        attendance_frame.pack(fill=tk.BOTH, padx=10, pady=5)

        # إنشاء إطار للبحث مع تصميم أفضل
        search_section = tk.Frame(attendance_frame, bg=self.colors["light"])
        search_section.pack(fill=tk.X, pady=(0, 10))

        # تقسيم منطقة البحث إلى قسمين - يمين ويسار
        search_right = tk.Frame(search_section, bg=self.colors["light"])
        search_right.pack(side=tk.RIGHT, fill=tk.Y)

        search_left = tk.Frame(search_section, bg=self.colors["light"])
        search_left.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

        # منطقة التاريخ على اليمين
        date_frame = tk.Frame(search_right, bg=self.colors["light"])
        date_frame.pack(side=tk.RIGHT, padx=10, fill=tk.Y)

        date_label = tk.Label(
            date_frame,
            text="التاريخ:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        )
        date_label.pack(side=tk.RIGHT, padx=5)

        self.date_entry = DateEntry(
            date_frame,
            width=12,
            background=self.colors["primary"],
            foreground='white',
            borderwidth=2,
            date_pattern='yyyy-mm-dd',
            font=self.fonts["text"],
            firstweekday="sunday",
            disableddays=(5, 6)
        )
        self.date_entry.pack(side=tk.RIGHT, padx=5)
        self.date_entry.set_date(self.today)
        self.date_entry.bind("<<DateEntrySelected>>", lambda e: self.update_statistics())

        # منطقة البحث على اليسار مع تصميم محسن
        search_box_frame = tk.Frame(search_left, bg=self.colors["light"])
        search_box_frame.pack(fill=tk.X, padx=10)

        search_icon_label = tk.Label(
            search_box_frame,
            text="🔍",
            font=(self.fonts["text"][0], 14),
            bg=self.colors["light"],
            fg=self.colors["primary"]
        )
        search_icon_label.pack(side=tk.RIGHT, padx=(0, 5))

        search_label = tk.Label(
            search_box_frame,
            text="بحث بالاسم أو الهوية:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        )
        search_label.pack(side=tk.RIGHT, padx=5)

        # مربع بحث بحجم أصغر ومظهر أفضل
        self.name_search_entry = tk.Entry(
            search_box_frame,
            font=self.fonts["text"],
            width=20,  # تقليل العرض
            bd=2,
            relief=tk.GROOVE
        )
        self.name_search_entry.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=False)
        self.name_search_entry.bind("<KeyRelease>", self.dynamic_name_search)

        # إضافة زر التراجع عن آخر تحضير بجانب مربع البحث
        undo_button = tk.Button(
            search_box_frame,
            text="↶ تراجع",  # أيقونة سهم التراجع
            font=self.fonts["text"],
            bg="#9E9E9E",  # لون رمادي
            fg="black",  # نص أسود
            padx=8,
            pady=2,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.undo_last_attendance
        )
        undo_button.pack(side=tk.RIGHT, padx=5)

        # إضافة tooltip للزر
        self.create_tooltip(undo_button, "التراجع عن آخر تسجيل حضور في هذه الجلسة")

        # تحسين مظهر قائمة النتائج
        results_frame = tk.Frame(attendance_frame, bg=self.colors["light"], pady=5)
        results_frame.pack(fill=tk.X, padx=10)

        results_label = tk.Label(
            results_frame,
            text="نتائج البحث:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"],
            fg=self.colors["primary"]
        )
        results_label.pack(side=tk.RIGHT, anchor=tk.N, padx=(0, 5))

        # إطار لقائمة النتائج مع شريط تمرير
        listbox_frame = tk.Frame(results_frame, bg=self.colors["light"])
        listbox_frame.pack(fill=tk.X, expand=True, side=tk.LEFT)

        # إضافة شريط تمرير
        listbox_scrollbar = tk.Scrollbar(listbox_frame)
        listbox_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        self.name_listbox = tk.Listbox(
            listbox_frame,
            font=self.fonts["text"],
            height=4,
            selectbackground=self.colors["primary"],
            bd=2,
            relief=tk.GROOVE,
            yscrollcommand=listbox_scrollbar.set
        )
        self.name_listbox.pack(fill=tk.X, expand=True)
        self.name_listbox.bind("<<ListboxSelect>>", self.on_name_select)

        # ربط شريط التمرير بالقائمة
        listbox_scrollbar.config(command=self.name_listbox.yview)

        # حقل خفي لتخزين الهوية
        self.id_entry = tk.Entry(self.root)

        # تحسين تصميم أزرار تسجيل الحضور - تعديل الأزرار المعروضة
        buttons_frame = tk.Frame(attendance_frame, bg=self.colors["light"])
        buttons_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)

        # توزيع الأعمدة بشكل متساوٍ
        for i in range(5):
            buttons_frame.columnconfigure(i, weight=1)

        # إنشاء إطارات الصفوف
        row1_frame = tk.Frame(buttons_frame, bg=self.colors["light"])
        row1_frame.pack(fill=tk.X, pady=(0, 5))

        row2_frame = tk.Frame(buttons_frame, bg=self.colors["light"])
        row2_frame.pack(fill=tk.X, pady=(5, 0))

        # الصف الأول من الأزرار - أزرار الحضور الأساسية
        buttons_row1 = [
            ("حاضر", self.colors["success"], lambda: self.insert_attendance_record("حاضر")),
            ("متأخر", self.colors["late"], lambda: self.insert_attendance_record("متأخر")),
            ("غائب", self.colors["danger"], lambda: self.insert_attendance_record("غائب")),
            ("غياب بعذر", self.colors["excused"], self.register_excused_absence),
            ("لم يباشر", self.colors["not_started"], lambda: self.insert_attendance_record("لم يباشر"))
        ]

        # الصف الثاني من الأزرار - الحالات الخاصة فقط
        buttons_row2 = [
            ("حالة وفاة", self.colors["death_case"], lambda: self.register_special_case("حالة وفاة")),
            ("منوم", self.colors["hospital"], lambda: self.register_special_case("منوم"))
        ]

        # إنشاء أزرار الصف الأول
        for i, (text, color, command) in enumerate(buttons_row1):
            btn = tk.Button(
                row1_frame,
                text=text,
                font=self.fonts["text_bold"],
                bg=color,
                fg="white",
                padx=5,
                pady=8,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=command
            )
            btn.pack(side=tk.RIGHT, padx=3, fill=tk.X, expand=True)

        # إنشاء أزرار الصف الثاني
        for i, (text, color, command) in enumerate(buttons_row2):
            btn = tk.Button(
                row2_frame,
                text=text,
                font=self.fonts["text_bold"],
                bg=color,
                fg="white",
                padx=5,
                pady=8,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=command
            )
            btn.pack(side=tk.RIGHT, padx=3, fill=tk.X, expand=True)

        # إضافة مؤشر آخر تسجيل بتصميم محسن
        status_frame = tk.Frame(attendance_frame, bg=self.colors["light"], pady=5)
        status_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

        self.last_registered_label = tk.Label(
            status_frame,
            text="",
            font=self.fonts["text_bold"],
            fg=self.colors["primary"],
            bg=self.colors["light"],
            anchor=tk.W  # محاذاة النص إلى اليمين
        )
        self.last_registered_label.pack(fill=tk.X)

    # 3. إضافة دالة create_tooltip لعرض تلميح عند التوقف فوق الزر:
    def create_tooltip(self, widget, text):
        """إنشاء تلميح يظهر عند التوقف فوق العنصر"""

        def on_enter(event):
            tooltip = tk.Toplevel()
            tooltip.wm_overrideredirect(True)
            tooltip.wm_geometry(f"+{event.x_root + 10}+{event.y_root + 10}")
            label = tk.Label(
                tooltip,
                text=text,
                font=self.fonts["small"],
                bg="#333333",
                fg="white",
                padx=5,
                pady=2
            )
            label.pack()
            widget.tooltip = tooltip

        def on_leave(event):
            if hasattr(widget, 'tooltip'):
                widget.tooltip.destroy()
                delattr(widget, 'tooltip')

        widget.bind("<Enter>", on_enter)
        widget.bind("<Leave>", on_leave)

    def register_attendance(self, event=None):
        self.insert_attendance_record("حاضر")

    def register_excused_absence(self):
        """تسجيل غياب بعذر مع خيار الإضافة للتكميل الرسمي"""
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("تنبيه", "ليس لديك صلاحية تسجيل الغياب بعذر")
            return

        # إنشاء نافذة بسيطة لإدخال نوع العذر
        excuse_window = tk.Toplevel(self.root)
        excuse_window.title("غياب بعذر")
        excuse_window.geometry("400x350")
        excuse_window.configure(bg=self.colors["light"])
        excuse_window.transient(self.root)
        excuse_window.grab_set()

        # توسيط النافذة
        x = (excuse_window.winfo_screenwidth() - 400) // 2
        y = (excuse_window.winfo_screenheight() - 350) // 2
        excuse_window.geometry(f"400x350+{x}+{y}")

        # عنوان النافذة
        tk.Label(
            excuse_window,
            text="تسجيل غياب بعذر",
            font=self.fonts["title"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=10
        ).pack(fill=tk.X)

        # إطار المحتوى
        content_frame = tk.Frame(excuse_window, bg=self.colors["light"], padx=20, pady=20)
        content_frame.pack(fill=tk.BOTH, expand=True)

        # اختيار نوع العذر
        tk.Label(
            content_frame,
            text="نوع العذر:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        ).pack(anchor=tk.W, pady=(0, 5))

        excuse_type_var = tk.StringVar(value="إجازة مرضية")

        tk.Radiobutton(
            content_frame,
            text="إجازة مرضية",
            variable=excuse_type_var,
            value="إجازة مرضية",
            font=self.fonts["text"],
            bg=self.colors["light"]
        ).pack(anchor=tk.W)

        tk.Radiobutton(
            content_frame,
            text="أخرى",
            variable=excuse_type_var,
            value="أخرى",
            font=self.fonts["text"],
            bg=self.colors["light"]
        ).pack(anchor=tk.W)

        # حقل إدخال السبب
        reason_label = tk.Label(
            content_frame,
            text="السبب:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        )

        reason_entry = tk.Entry(
            content_frame,
            font=self.fonts["text"],
            width=30
        )

        def toggle_reason_field(*args):
            if excuse_type_var.get() == "أخرى":
                reason_label.pack(anchor=tk.W, pady=(10, 5))
                reason_entry.pack(fill=tk.X)
                reason_entry.focus_set()
            else:
                reason_label.pack_forget()
                reason_entry.pack_forget()

        excuse_type_var.trace("w", toggle_reason_field)

        # أزرار الإجراءات
        buttons_frame = tk.Frame(excuse_window, bg=self.colors["light"], pady=10)
        buttons_frame.pack(fill=tk.X, padx=20)

        def save_excuse():
            excuse_type = excuse_type_var.get()
            reason = ""

            if excuse_type == "أخرى":
                reason = reason_entry.get().strip()
                if not reason:
                    messagebox.showwarning("تنبيه", "الرجاء إدخال السبب")
                    return

            # السؤال عن التكميل الرسمي
            add_to_official = messagebox.askyesno(
                "التكميل الرسمي",
                "هل تريد أن يظهر هذا الغياب في التكميل الرسمي؟"
            )

            # تحضير السبب النهائي
            if excuse_type == "إجازة مرضية":
                final_reason = "إجازة مرضية"
            else:
                final_reason = reason

            # إضافة علامة التكميل الرسمي إذا تم اختيارها
            if add_to_official:
                final_reason += " [تكميل رسمي]"

            # تسجيل الحضور
            self.insert_attendance_record("غائب بعذر", excuse_reason=final_reason)
            excuse_window.destroy()

        tk.Button(
            buttons_frame,
            text="حفظ",
            font=self.fonts["text_bold"],
            bg=self.colors["success"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=save_excuse
        ).pack(side=tk.LEFT, padx=5)

        tk.Button(
            buttons_frame,
            text="إلغاء",
            font=self.fonts["text_bold"],
            bg=self.colors["danger"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=excuse_window.destroy
        ).pack(side=tk.RIGHT, padx=5)

    # 5. إضافة دالة التراجع عن آخر تحضير:
    def undo_last_attendance(self):
        """التراجع عن آخر عملية تسجيل حضور في الجلسة الحالية"""

        # التحقق من وجود سجلات للتراجع عنها
        if not self.session_attendance_history:
            messagebox.showinfo("تنبيه", "لا توجد عمليات تسجيل حضور للتراجع عنها في هذه الجلسة")
            return

        # الحصول على آخر تسجيل
        last_record = self.session_attendance_history.pop()

        # التحقق من أن التسجيل في نفس اليوم الحالي
        current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
        if last_record['date'] != current_date:
            messagebox.showwarning(
                "تنبيه",
                "لا يمكن التراجع عن تسجيلات الأيام السابقة.\n"
                "يمكن التراجع فقط عن تسجيلات اليوم الحالي في نفس الجلسة."
            )
            # إعادة السجل إلى القائمة
            self.session_attendance_history.append(last_record)
            return

        try:
            # حذف التسجيل من قاعدة البيانات
            with self.conn:
                self.conn.execute("DELETE FROM attendance WHERE id=?", (last_record['id'],))

            # عرض رسالة التأكيد
            messagebox.showinfo(
                "تم التراجع",
                f"تم إزالة التحضير عن:\n"
                f"المتدرب: {last_record['name']}\n"
                f"الدورة: {last_record['course']}\n"
                f"الحالة: {last_record['status']}\n"
                f"الوقت: {last_record['time']}"
            )

            # تحديث الإحصائيات والعرض
            self.update_statistics()
            self.update_attendance_display()

        except Exception as e:
            messagebox.showerror("خطأ", f"حدث خطأ أثناء التراجع عن التسجيل: {str(e)}")
            # إعادة السجل إلى القائمة في حالة الخطأ
            self.session_attendance_history.append(last_record)

    def setup_bulk_attendance(self):
        """إضافة زر لفتح نافذة إدخال أرقام الهويات بالباركود"""
        # إنشاء إطار بسيط للأزرار الجماعية
        buttons_frame = tk.Frame(self.attendance_tab, bg=self.colors["light"], padx=10, pady=10)
        buttons_frame.pack(fill=tk.X, padx=10, pady=5)



        # زر تسجيل حضور الكل (غير المسجلين)
        bulk_all_present_button = tk.Button(
            buttons_frame,
            text="تسجيل الحضور للكل (غير المسجلين)",
            font=self.fonts["text_bold"],
            bg=self.colors["success"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            command=self.register_all_unmarked_as_present,
            cursor="hand2"
        )
        bulk_all_present_button.pack(side=tk.LEFT, padx=5)

        # زر تسجيل حضور دورة كاملة
        course_attendance_button = tk.Button(
            buttons_frame,
            text="تسجيل حضور دورة كاملة",
            font=self.fonts["text_bold"],
            bg=self.colors["primary"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            command=self.register_whole_course,
            cursor="hand2"
        )
        course_attendance_button.pack(side=tk.LEFT, padx=5)

        # زر فتح نافذة إدخال أرقام الهويات بالباركود
        barcode_window_button = tk.Button(
            buttons_frame,
            text="تسجيل بالباركود",
            font=self.fonts["text_bold"],
            bg=self.colors["secondary"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            command=self.open_barcode_window,
            cursor="hand2"
        )
        barcode_window_button.pack(side=tk.LEFT, padx=5)

        # زر عرض المتدربين غير المسجلين
        unregistered_button = tk.Button(
            buttons_frame,
            text="عرض المتدربين غير المسجلين",
            font=self.fonts["text_bold"],
            bg="#673AB7",  # لون بنفسجي مميز
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            command=self.show_unregistered_students,
            cursor="hand2"
        )
        unregistered_button.pack(side=tk.LEFT, padx=5)

    def open_barcode_window(self):
        """فتح نافذة جديدة لإدخال أرقام الهويات بالباركود"""
        # إنشاء نافذة جديدة
        barcode_window = tk.Toplevel(self.root)
        barcode_window.title("إدخال أرقام الهويات بالباركود")
        barcode_window.geometry("800x750")  # نافذة أطول لإظهار الأزرار
        barcode_window.configure(bg=self.colors["light"])

        # توسيط النافذة
        x = (barcode_window.winfo_screenwidth() - 800) // 2
        y = (barcode_window.winfo_screenheight() - 750) // 2
        barcode_window.geometry(f"800x750+{x}+{y}")

        # إطار العنوان الرئيسي
        title_frame = tk.Frame(barcode_window, bg=self.colors["primary"], padx=20, pady=20)
        title_frame.pack(fill=tk.X)

        title_label = tk.Label(
            title_frame,
            text="إدخال أرقام الهويات بالباركود وتسجيل الحضور الجماعي",
            font=("Tajawal", 24, "bold"),  # خط كبير وعريض
            bg=self.colors["primary"],
            fg="white"
        )
        title_label.pack()

        # إطار التاريخ - تعديل ليشمل زر اللصق
        date_frame = tk.Frame(barcode_window, bg=self.colors["light"], padx=20, pady=10)
        date_frame.pack(fill=tk.X)

        tk.Label(
            date_frame,
            text="التاريخ:",
            font=("Tajawal", 16, "bold"),  # خط كبير وعريض
            bg=self.colors["light"]
        ).pack(side=tk.RIGHT, padx=10)

        barcode_date_entry = DateEntry(
            date_frame,
            width=15,
            background=self.colors["primary"],
            foreground='white',
            borderwidth=2,
            date_pattern='yyyy-mm-dd',
            font=("Tajawal", 16),  # خط كبير
            firstweekday="sunday"
        )
        barcode_date_entry.pack(side=tk.RIGHT, padx=10)
        barcode_date_entry.set_date(self.today)

        # إضافة زر لصق جديد
        paste_btn = tk.Button(
            date_frame,
            text="لصق",
            font=("Tajawal", 14),
            bg=self.colors["secondary"],
            fg="white",
            padx=8, pady=2,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: paste_clipboard_content(barcode_text)
        )
        paste_btn.pack(side=tk.LEFT, padx=10)

        # إطار إدخال أرقام الهويات
        input_frame = tk.LabelFrame(
            barcode_window,
            text="إدخال أرقام الهويات",
            font=("Tajawal", 18, "bold"),  # خط كبير وعريض
            bg=self.colors["light"],
            fg=self.colors["dark"],
            padx=20, pady=20
        )
        input_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

        # توجيهات الاستخدام
        instructions = tk.Label(
            input_frame,
            text="أدخل أرقام الهويات (كل رقم هوية في سطر منفصل):",
            font=("Tajawal", 16, "bold"),  # خط كبير وعريض
            bg=self.colors["light"],
            anchor=tk.W
        )
        instructions.pack(fill=tk.X, pady=(0, 10))

        # إطار النص مع شريط التمرير
        text_frame = tk.Frame(input_frame, bg=self.colors["light"])
        text_frame.pack(fill=tk.BOTH, expand=True, pady=10)

        scrollbar = tk.Scrollbar(text_frame)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        barcode_text = tk.Text(
            text_frame,
            font=("Tajawal", 14),  # خط أصغر
            height=18,  # زيادة ارتفاع مربع النص
            width=40,
            wrap=tk.WORD,
            yscrollcommand=scrollbar.set,
            bd=2,
            relief=tk.GROOVE
        )
        barcode_text.pack(fill=tk.BOTH, expand=True)
        scrollbar.config(command=barcode_text.yview)

        # تركيز مؤشر الكتابة في حقل النص
        barcode_text.focus_set()

        # دالة لصق محتوى الحافظة
        def paste_clipboard_content(text_widget):
            try:
                clipboard_content = barcode_window.clipboard_get()
                text_widget.insert(tk.END, clipboard_content)
            except tk.TclError:
                messagebox.showinfo("تنبيه", "لا يوجد محتوى في الحافظة")

        # إطار الأزرار
        buttons_frame = tk.Frame(barcode_window, bg=self.colors["light"], padx=20, pady=20)
        buttons_frame.pack(fill=tk.X)

        # دالة لمعالجة أرقام الهويات
        # دالة لمعالجة أرقام الهويات
        def process_barcodes(status):
            """معالجة أرقام الهويات المدخلة وتسجيل حضورهم"""
            barcode_ids = barcode_text.get("1.0", tk.END).strip()
            if not barcode_ids:
                messagebox.showinfo("تنبيه", "الرجاء إدخال أرقام الهويات أولاً")
                return

            id_lines = [line.strip() for line in barcode_ids.split("\n") if line.strip()]
            if not id_lines:
                messagebox.showinfo("تنبيه", "لم يتم العثور على أرقام هويات صالحة")
                return

            # الحصول على التاريخ المحدد
            selected_date = barcode_date_entry.get_date().strftime("%Y-%m-%d")
            current_time = datetime.datetime.now().strftime("%H:%M:%S")

            # التحقق من التاريخ السابق
            current_date_obj = barcode_date_entry.get_date()
            yesterday_date_obj = current_date_obj - datetime.timedelta(days=1)
            yesterday_date = yesterday_date_obj.strftime("%Y-%m-%d")

            cursor = self.conn.cursor()

            # قوائم لتتبع النتائج
            successful_ids = []
            failed_ids = []
            already_registered_ids = []
            excluded_ids = []
            absence_alerts = []
            receivers_dict = {}  # لحفظ أسماء المستقبلين

            # إذا كانت الحالة "حاضر" أو "متأخر"، نحتاج للتحقق من المتدربين الذين كانوا "لم يباشر" بالأمس
            if status in ["حاضر", "متأخر"]:
                not_started_yesterday = []

                for national_id in id_lines:
                    if not national_id:
                        continue

                    # التحقق من حالة المتدرب بالأمس
                    cursor.execute("""
                        SELECT t.name 
                        FROM attendance a
                        JOIN trainees t ON a.national_id = t.national_id
                        WHERE a.national_id=? AND a.date=? AND a.status='لم يباشر'
                        AND t.is_excluded=0
                    """, (national_id, yesterday_date))

                    result = cursor.fetchone()
                    if result:
                        not_started_yesterday.append({
                            'national_id': national_id,
                            'name': result[0]
                        })

                # إذا وجد متدربين كانوا "لم يباشر" بالأمس، نطلب أسماء المستقبلين
                if not_started_yesterday:
                    receivers_dict = self.get_bulk_receivers_for_not_started(not_started_yesterday, "تسجيل بالباركود")
                    if receivers_dict is None:
                        return  # المستخدم ألغى العملية

            # معالجة كل رقم هوية
            for national_id in id_lines:
                try:
                    # التحقق من وجود المتدرب وما إذا كان مستبعدًا
                    cursor.execute("""
                        SELECT national_id, name, rank, course, is_excluded 
                        FROM trainees 
                        WHERE national_id=?
                    """, (national_id,))

                    trainee = cursor.fetchone()
                    if not trainee:
                        failed_ids.append(national_id)
                        continue

                    # التحقق من استبعاد المتدرب
                    if trainee[4] == 1:
                        excluded_ids.append(national_id)
                        continue

                    # التحقق مما إذا كان المتدرب مسجلاً بالفعل لهذا اليوم
                    cursor.execute("SELECT status FROM attendance WHERE national_id=? AND date=?",
                                   (trainee[0], selected_date))
                    existing_record = cursor.fetchone()

                    if existing_record:
                        already_registered_ids.append(national_id)
                        continue

                    # التحقق من حالة المتدرب في اليوم السابق
                    cursor.execute("SELECT status FROM attendance WHERE national_id=? AND date=?",
                                   (trainee[0], yesterday_date))
                    yesterday_record = cursor.fetchone()

                    # معالجة الحالات المختلفة
                    final_status = status  # الحالة النهائية التي سيتم تسجيلها
                    receiver_name = receivers_dict.get(national_id, "")

                    if yesterday_record and yesterday_record[0] == "لم يباشر":
                        if status in ["حاضر", "متأخر"]:
                            # المتدرب كان "لم يباشر" بالأمس واليوم "حاضر" أو "متأخر" - مطلوب اسم المستقبل
                            if not receiver_name:
                                # لم يتم إدخال اسم المستقبل، تخطي هذا المتدرب
                                failed_ids.append(national_id)
                                continue
                        elif status == "لم يباشر":
                            # المتدرب كان "لم يباشر" بالأمس واليوم أيضاً "لم يباشر" - مسموح
                            pass
                        elif status == "غائب":
                            # المتدرب كان "لم يباشر" بالأمس واليوم "غائب" - نمنع التسجيل
                            messagebox.showerror("خطأ",
                                                 f"لا يمكن تسجيل المتدرب {trainee[1]} كـ 'غائب'\n\n"
                                                 "المتدرب كان في حالة 'لم يباشر' بالأمس.\n"
                                                 "يجب تسجيله كـ:\n"
                                                 "• 'حاضر' أو 'متأخر' إذا حضر اليوم\n"
                                                 "• 'لم يباشر' إذا لم يباشر بعد\n\n"
                                                 "تسجيله كـ 'غائب' مخالف لتعليمات التدريب المستديمة."
                                                 )
                            # تخطي هذا المتدرب
                            failed_ids.append(national_id)
                            continue

                    # فحص تنبيهات الغياب إذا كان التسجيل غيابًا
                    if final_status == "غائب":
                        absence_alert, alert_message, alert_type, alert_color = self.check_student_absence(trainee[0],
                                                                                                           selected_date)
                        if absence_alert:
                            absence_alerts.append((alert_message, alert_type, alert_color))

                    # إدراج سجل حضور جديد
                    with self.conn:
                        cursor.execute("""
                            INSERT INTO attendance (
                                national_id, name, rank, course,
                                time, date, status, original_status,
                                registered_by, excuse_reason,
                                updated_by, updated_at, receiver_name
                            )
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        """, (
                            trainee[0], trainee[1], trainee[2], trainee[3],
                            current_time, selected_date,
                            final_status, final_status,
                            self.current_user["full_name"], "",
                            "", "", receiver_name
                        ))

                        # الحصول على معرف التسجيل وإضافته للسجل
                        attendance_id = cursor.lastrowid
                        self.session_attendance_history.append({
                            'id': attendance_id,
                            'national_id': trainee[0],
                            'name': trainee[1],
                            'course': trainee[3],
                            'status': final_status,
                            'date': selected_date,
                            'time': current_time
                        })

                    successful_ids.append(national_id)

                except Exception as e:
                    print(f"خطأ في معالجة الهوية {national_id}: {str(e)}")
                    failed_ids.append(national_id)

            # إعداد رسالة ملخص النتائج
            result_message = f"تمت معالجة {len(id_lines)} رقم هوية:\n\n"

            if successful_ids:
                result_message += f"✅ تم تسجيل {len(successful_ids)} متدرب بنجاح.\n"

            if already_registered_ids:
                result_message += f"⚠️ {len(already_registered_ids)} متدرب مسجل مسبقاً في هذا اليوم.\n"

            if excluded_ids:
                result_message += f"❌ {len(excluded_ids)} متدرب مستبعد لا يمكن تسجيل حضورهم.\n"

            if failed_ids:
                result_message += f"❓ {len(failed_ids)} رقم هوية غير موجود في قاعدة البيانات أو لم يتم معالجته."

            # عرض النتائج
            messagebox.showinfo("نتائج تسجيل الحضور", result_message)

            # تفريغ مربع النص بعد المعالجة الناجحة إذا تم تسجيل متدربين بنجاح
            if successful_ids:
                barcode_text.delete("1.0", tk.END)

            # تحديث الإحصائيات وعرض الحضور
            self.update_statistics()
            self.update_attendance_display()

            # عرض تنبيهات الغياب المتكرر (إذا وجدت)
            if absence_alerts:
                first_alert = absence_alerts[0]
                self.show_absence_alert(
                    first_alert[0] + f"\n\nملاحظة: هناك {len(absence_alerts)} تنبيه غياب متكرر في هذه المجموعة."
                    if len(absence_alerts) > 1 else first_alert[0],
                    first_alert[1],
                    first_alert[2]
                )

            # إغلاق النافذة تلقائيًا بعد التسجيل الناجح
            if successful_ids:
                barcode_window.destroy()

        # أزرار تسجيل الحضور
        present_btn = tk.Button(
            buttons_frame,
            text="تسجيل حضور",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["success"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: process_barcodes("حاضر")
        )
        present_btn.pack(side=tk.LEFT, padx=10)

        late_btn = tk.Button(
            buttons_frame,
            text="تسجيل تأخير",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["late"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: process_barcodes("متأخر")
        )
        late_btn.pack(side=tk.LEFT, padx=10)

        # إضافة زر غياب (جديد)
        absent_btn = tk.Button(
            buttons_frame,
            text="غياب",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["danger"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: process_barcodes("غائب")
        )
        absent_btn.pack(side=tk.LEFT, padx=10)

        # زر لم يباشر
        not_started_btn = tk.Button(
            buttons_frame,
            text="لم يباشر",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["not_started"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: process_barcodes("لم يباشر")
        )
        not_started_btn.pack(side=tk.LEFT, padx=10)

        clear_btn = tk.Button(
            buttons_frame,
            text="تفريغ الحقل",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["dark"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: barcode_text.delete("1.0", tk.END)
        )
        clear_btn.pack(side=tk.RIGHT, padx=10)

        close_btn = tk.Button(
            buttons_frame,
            text="إغلاق",
            font=("Tajawal", 14, "bold"),
            bg="#9E9E9E",  # لون رمادي
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=barcode_window.destroy
        )
        close_btn.pack(side=tk.RIGHT, padx=10)

    def process_barcode_ids(self, status):
        """معالجة أرقام الهويات المدخلة بالباركود مع دعم المستقبلين"""
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("تنبيه", "ليس لديك صلاحية تسجيل الحضور والغياب")
            return

        # قراءة النص من مربع الإدخال
        barcode_text = self.barcode_text.get(1.0, tk.END).strip()
        if not barcode_text:
            messagebox.showinfo("تنبيه", "الرجاء إدخال أرقام الهويات أولاً")
            return

        # تقسيم النص إلى أسطر للحصول على أرقام الهويات
        id_lines = [line.strip() for line in barcode_text.split("\n") if line.strip()]
        if not id_lines:
            messagebox.showinfo("تنبيه", "لم يتم العثور على أرقام هويات صالحة")
            return

        # الحصول على التاريخ الحالي ووقت التسجيل
        current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
        current_time = datetime.datetime.now().strftime("%H:%M:%S")

        # التحقق من التاريخ السابق
        current_date_obj = self.date_entry.get_date()
        yesterday_date_obj = current_date_obj - datetime.timedelta(days=1)
        yesterday_date = yesterday_date_obj.strftime("%Y-%m-%d")

        cursor = self.conn.cursor()

        # إذا كانت الحالة "حاضر" أو "متأخر"، نحتاج للتحقق من المتدربين الذين كانوا "لم يباشر" بالأمس
        receivers_dict = {}
        if status in ["حاضر", "متأخر"]:
            not_started_yesterday = []

            for national_id in id_lines:
                if not national_id:
                    continue

                # التحقق من حالة المتدرب بالأمس
                cursor.execute("""
                    SELECT t.name 
                    FROM attendance a
                    JOIN trainees t ON a.national_id = t.national_id
                    WHERE a.national_id=? AND a.date=? AND a.status='لم يباشر'
                    AND t.is_excluded=0
                """, (national_id, yesterday_date))

                result = cursor.fetchone()
                if result:
                    not_started_yesterday.append({
                        'national_id': national_id,
                        'name': result[0]
                    })

            # إذا وجد متدربين كانوا "لم يباشر" بالأمس، نطلب أسماء المستقبلين
            if not_started_yesterday:
                receivers_dict = self.get_bulk_receivers_for_not_started(not_started_yesterday, "تسجيل بالباركود")
                if receivers_dict is None:
                    return  # المستخدم ألغى العملية

        # قوائم لتتبع النتائج
        successful_ids = []
        failed_ids = []
        already_registered_ids = []
        excluded_ids = []
        absence_alerts = []

        # معالجة كل رقم هوية
        for national_id in id_lines:
            if not national_id:
                continue

            try:
                # التحقق من وجود المتدرب وما إذا كان مستبعدًا
                cursor.execute("""
                    SELECT national_id, name, rank, course, is_excluded 
                    FROM trainees 
                    WHERE national_id=?
                """, (national_id,))

                trainee = cursor.fetchone()
                if not trainee:
                    failed_ids.append(national_id)
                    continue

                # التحقق من استبعاد المتدرب
                if trainee[4] == 1:
                    excluded_ids.append(national_id)
                    continue

                # التحقق مما إذا كان المتدرب مسجلاً بالفعل لهذا اليوم
                cursor.execute("SELECT status FROM attendance WHERE national_id=? AND date=?",
                               (trainee[0], current_date))
                existing_record = cursor.fetchone()

                if existing_record:
                    already_registered_ids.append(national_id)
                    continue

                # الحصول على اسم المستقبل إذا كان متوفراً
                receiver_name = receivers_dict.get(national_id, "")

                # فحص تنبيهات الغياب إذا كان التسجيل غيابًا
                if status == "غائب":
                    absence_alert, alert_message, alert_type, alert_color = self.check_student_absence(trainee[0],
                                                                                                       current_date)
                    if absence_alert:
                        absence_alerts.append((alert_message, alert_type, alert_color))

                # إدراج سجل حضور جديد
                with self.conn:
                    cursor.execute("""
                        INSERT INTO attendance (
                            national_id, name, rank, course,
                            time, date, status, original_status,
                            registered_by, excuse_reason,
                            updated_by, updated_at, receiver_name
                        )
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    """, (
                        trainee[0], trainee[1], trainee[2], trainee[3],
                        current_time, current_date,
                        status, status,
                        self.current_user["full_name"], "",
                        "", "", receiver_name
                    ))

                    # الحصول على معرف التسجيل وإضافته للسجل
                    attendance_id = cursor.lastrowid
                    self.session_attendance_history.append({
                        'id': attendance_id,
                        'national_id': trainee[0],
                        'name': trainee[1],
                        'course': trainee[3],
                        'status': status,
                        'date': current_date,
                        'time': current_time
                    })

                successful_ids.append(national_id)

            except Exception as e:
                print(f"خطأ في معالجة الهوية {national_id}: {str(e)}")
                failed_ids.append(national_id)

        # إعداد رسالة ملخص النتائج
        result_message = f"تمت معالجة {len(id_lines)} رقم هوية:\n\n"

        if successful_ids:
            result_message += f"✅ تم تسجيل {len(successful_ids)} متدرب بنجاح بحالة '{status}'.\n"

        if already_registered_ids:
            result_message += f"⚠️ {len(already_registered_ids)} متدرب مسجل مسبقاً في هذا اليوم.\n"

        if excluded_ids:
            result_message += f"❌ {len(excluded_ids)} متدرب مستبعد لا يمكن تسجيل حضورهم.\n"

        if failed_ids:
            result_message += f"❓ {len(failed_ids)} رقم هوية غير موجود في قاعدة البيانات."

        # عرض النتائج
        messagebox.showinfo("نتائج تسجيل الحضور", result_message)

        # تفريغ مربع النص بعد المعالجة الناجحة إذا تم تسجيل متدربين بنجاح
        if successful_ids:
            self.barcode_text.delete(1.0, tk.END)

        # تحديث الإحصائيات وعرض الحضور
        self.update_statistics()
        self.update_attendance_display()

        # عرض تنبيهات الغياب المتكرر (إذا وجدت)
        if absence_alerts:
            first_alert = absence_alerts[0]
            self.show_absence_alert(
                first_alert[0] + f"\n\nملاحظة: هناك {len(absence_alerts)} تنبيه غياب متكرر في هذه المجموعة."
                if len(absence_alerts) > 1 else first_alert[0],
                first_alert[1],
                first_alert[2]
            )

    def register_all_unmarked_as_present(self):
        """تسجيل الحضور للكل (غير المسجلين) - محدث لحل مشكلة تكرار اسم المستقبل"""
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("تنبيه", "ليس لديك صلاحية تسجيل الحضور والغياب")
            return

        current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
        current_time = datetime.datetime.now().strftime("%H:%M:%S")

        # التحقق من التاريخ السابق
        current_date_obj = self.date_entry.get_date()
        yesterday_date_obj = current_date_obj - datetime.timedelta(days=1)
        yesterday_date = yesterday_date_obj.strftime("%Y-%m-%d")

        # إنشاء نافذة تقدم العملية
        progress_window = tk.Toplevel(self.root)
        progress_window.title("تسجيل حضور جماعي")
        progress_window.geometry("450x150")
        progress_window.configure(bg=self.colors["light"])
        progress_window.transient(self.root)
        progress_window.grab_set()

        x = (progress_window.winfo_screenwidth() - 450) // 2
        y = (progress_window.winfo_screenheight() - 150) // 2
        progress_window.geometry(f"450x150+{x}+{y}")

        progress_var = tk.DoubleVar()
        tk.Label(
            progress_window,
            text="جاري تسجيل الحضور للمتدربين غير المسجلين...",
            font=self.fonts["text_bold"],
            bg=self.colors["light"],
            pady=10
        ).pack()

        progress_bar = ttk.Progressbar(
            progress_window,
            variable=progress_var,
            maximum=100,
            length=400
        )
        progress_bar.pack(pady=10)

        status_label = tk.Label(
            progress_window,
            text="جاري الإعداد...",
            font=self.fonts["text"],
            bg=self.colors["light"]
        )
        status_label.pack(pady=5)

        progress_window.update()

        try:
            cursor = self.conn.cursor()

            # الحصول على المتدربين غير المسجلين
            status_label.config(text="جاري تحديد المتدربين غير المسجلين...")
            progress_window.update()

            # أولاً، نحصل على قائمة المتدربين الذين كانوا "لم يباشر" بالأمس
            # والذين لم يتم تسجيلهم اليوم أو ليس لديهم اسم مستقبل مسجل
            cursor.execute("""
                SELECT t.national_id, t.name
                FROM attendance a
                JOIN trainees t ON a.national_id = t.national_id
                WHERE a.date = ? AND a.status = 'لم يباشر' AND t.is_excluded = 0
                AND NOT EXISTS (
                    SELECT 1 FROM attendance a2 
                    WHERE a2.national_id = a.national_id 
                    AND a2.date = ? 
                    AND (a2.receiver_name IS NOT NULL AND a2.receiver_name != '')
                )
            """, (yesterday_date, current_date))

            not_started_yesterday = []
            for row in cursor.fetchall():
                not_started_yesterday.append({
                    'national_id': row[0],
                    'name': row[1]
                })

            # إذا وجد متدربين يحتاجون اسم مستقبل
            receivers_dict = {}
            if not_started_yesterday:
                progress_window.destroy()
                receivers_dict = self.get_bulk_receivers_for_not_started(not_started_yesterday, "تسجيل حضور جماعي")
                if receivers_dict is None:
                    return  # المستخدم ألغى العملية

                # إعادة إنشاء نافذة التقدم
                progress_window = tk.Toplevel(self.root)
                progress_window.title("تسجيل حضور جماعي")
                progress_window.geometry("450x150")
                progress_window.configure(bg=self.colors["light"])
                progress_window.transient(self.root)
                progress_window.grab_set()
                x = (progress_window.winfo_screenwidth() - 450) // 2
                y = (progress_window.winfo_screenheight() - 150) // 2
                progress_window.geometry(f"450x150+{x}+{y}")

                progress_var = tk.DoubleVar()
                tk.Label(
                    progress_window,
                    text="جاري تسجيل الحضور للمتدربين غير المسجلين...",
                    font=self.fonts["text_bold"],
                    bg=self.colors["light"],
                    pady=10
                ).pack()

                progress_bar = ttk.Progressbar(
                    progress_window,
                    variable=progress_var,
                    maximum=100,
                    length=400
                )
                progress_bar.pack(pady=10)

                status_label = tk.Label(
                    progress_window,
                    text="جاري المعالجة...",
                    font=self.fonts["text"],
                    bg=self.colors["light"]
                )
                status_label.pack(pady=5)
                progress_window.update()

            # الحصول على المتدربين غير المسجلين
            cursor.execute("""
                SELECT t.national_id, t.name, t.rank, t.course
                FROM trainees t
                WHERE t.is_excluded=0
                AND NOT EXISTS (
                    SELECT 1 FROM attendance a 
                    WHERE a.national_id = t.national_id AND a.date = ?
                )
            """, (current_date,))

            unregistered_students = cursor.fetchall()

            if not unregistered_students:
                progress_window.destroy()
                messagebox.showinfo("ملاحظة", "لا يوجد متدربين غير مسجلين اليوم.")
                return

            # معالجة كل متدرب
            rows_affected = 0
            total_students = len(unregistered_students)

            for i, student in enumerate(unregistered_students):
                national_id, name, rank, course = student

                # تحديث شريط التقدم
                progress_var.set((i / total_students) * 100)
                status_label.config(text=f"معالجة المتدرب {i + 1} من {total_students}")
                progress_window.update()

                # التحقق من وجود اسم مستقبل مسجل مسبقاً لهذا المتدرب اليوم
                receiver_name = ""

                # أولاً، تحقق من وجود تسجيل سابق اليوم مع اسم مستقبل
                cursor.execute("""
                    SELECT receiver_name 
                    FROM attendance 
                    WHERE national_id=? AND date=? AND receiver_name IS NOT NULL AND receiver_name != ''
                    LIMIT 1
                """, (national_id, current_date))

                existing_receiver = cursor.fetchone()
                if existing_receiver:
                    receiver_name = existing_receiver[0]
                else:
                    # إذا لم يكن هناك تسجيل سابق، استخدم اسم المستقبل من القاموس
                    receiver_name = receivers_dict.get(national_id, "")

                # إدراج السجل
                with self.conn:
                    cursor.execute("""
                        INSERT INTO attendance (
                            national_id, name, rank, course, time, date, status, 
                            original_status, registered_by, excuse_reason, updated_by, 
                            updated_at, receiver_name
                        )
                        VALUES (?, ?, ?, ?, ?, ?, 'حاضر', 'حاضر', ?, '', '', '', ?)
                    """, (national_id, name, rank, course, current_time, current_date,
                          self.current_user["full_name"], receiver_name))

                    rows_affected += 1

            progress_var.set(100)
            status_label.config(text="تم الانتهاء بنجاح!")
            progress_window.update()

            # إغلاق نافذة التقدم بعد ثانيتين
            progress_window.after(2000, progress_window.destroy)

            if rows_affected > 0:
                messagebox.showinfo("نجاح", f"تم تسجيل حضور {rows_affected} متدرب غير مسجل بنجاح.")
            else:
                messagebox.showinfo("ملاحظة", "لا يوجد متدربين غير مسجلين اليوم.")

            self.update_statistics()
            self.update_attendance_display()

        except Exception as e:
            try:
                progress_window.destroy()
            except:
                pass
            messagebox.showerror("خطأ", f"حدث خطأ: {str(e)}")

    def register_bulk_lateness(self):
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("تنبيه", "ليس لديك صلاحية تسجيل الحضور والغياب")
            return

        if not messagebox.askyesnocancel("تأكيد", "هل تريد تسجيل تأخير جماعي لجميع المتدربين الذين لم يتم تسجيلهم اليوم؟"):
            return

        current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
        current_time = datetime.datetime.now().strftime("%H:%M:%S")

        cursor = self.conn.cursor()
        # استثناء المتدربين المستبعدين
        cursor.execute("""
            SELECT national_id, name, rank, course 
            FROM trainees 
            WHERE is_excluded=0
        """)
        all_students = cursor.fetchall()
        cursor.execute("SELECT DISTINCT national_id FROM attendance WHERE date=?", (current_date,))
        already_recorded = set(row[0] for row in cursor.fetchall())

        new_late_rows = []
        for student in all_students:
            if student[0] not in already_recorded:
                new_late_rows.append((
                    student[0], student[1], student[2], student[3],
                    current_time, current_date,
                    "متأخر", "متأخر",
                    self.current_user["full_name"], "",
                    "", ""
                ))

        if not new_late_rows:
            messagebox.showinfo("ملاحظة", "لا يوجد متدربين غير مسجلين.")
            return

        try:
            with self.conn:
                self.conn.executemany("""
                    INSERT INTO attendance (
                        national_id, name, rank, course,
                        time, date, status, original_status,
                        registered_by, excuse_reason,
                        updated_by, updated_at
                    )
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, new_late_rows)
            messagebox.showinfo("نجاح", f"تم تسجيل تأخير {len(new_late_rows)} متدرب بنجاح")
            self.update_statistics()
            self.update_attendance_display()
        except Exception as e:
            messagebox.showerror("خطأ", str(e))

    def register_special_case(self, status):
        """دالة تسجيل الحالات الخاصة (وفاة، منوم) مع طلب تفاصيل إضافية"""
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("تنبيه", "ليس لديك صلاحية تسجيل الحضور والغياب")
            return

        details = simpledialog.askstring(f"تفاصيل {status}", f"أدخل تفاصيل {status}:")
        if details is None:  # إذا ضغط المستخدم على زر الإلغاء
            return

        self.insert_attendance_record(status, excuse_reason=details)

    def bulk_register(self):
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("تنبيه", "ليس لديك صلاحية تسجيل الحضور والغياب")
            return

        text_data = self.bulk_text.get("1.0", tk.END).strip()
        if not text_data:
            return

        current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
        lines = text_data.split("\n")

        cursor = self.conn.cursor()
        new_rows = []

        for line in lines:
            nid = line.strip()
            if not nid:
                continue

            # التحقق من استبعاد المتدرب
            cursor.execute("""
                SELECT national_id, name, rank, course, is_excluded 
                FROM trainees 
                WHERE national_id=?
            """, (nid,))

            trainee = cursor.fetchone()
            if not trainee:
                continue

            # تخطي المتدربين المستبعدين
            if trainee[4] == 1:
                continue

            cursor.execute("SELECT status FROM attendance WHERE national_id=? AND date=?", (trainee[0], current_date))
            existing_record = cursor.fetchone()
            if existing_record:
                continue

            current_time = datetime.datetime.now().strftime("%H:%M:%S")
            new_rows.append((
                trainee[0], trainee[1], trainee[2], trainee[3],
                current_time, current_date,
                "حاضر", "حاضر",
                self.current_user["full_name"], "",
                "", ""
            ))

        if not new_rows:
            messagebox.showinfo("ملاحظة", "لا يوجد متدربين جدد للتسجيل.")
            return

        try:
            with self.conn:
                self.conn.executemany("""
                    INSERT INTO attendance (
                        national_id, name, rank, course,
                        time, date, status, original_status,
                        registered_by, excuse_reason,
                        updated_by, updated_at
                    )
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, new_rows)
            messagebox.showinfo("نجاح", f"تم تسجيل حضور {len(new_rows)} متدرب بنجاح")
            self.bulk_text.delete("1.0", tk.END)
            self.update_statistics()
            self.update_attendance_display()
        except Exception as e:
            messagebox.showerror("خطأ", str(e))

    # تعديل دالة register_whole_course مع حذف أزرار الغياب وإضافة معالجة المستقبلين
    def register_whole_course(self):
        """تسجيل حضور لدورات متعددة بحالة محددة - محدث لحل مشكلة تكرار اسم المستقبل"""
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("تنبيه", "ليس لديك صلاحية تسجيل الحضور والغياب")
            return

        # إنشاء نافذة اختيار الدورات والحالة
        select_window = tk.Toplevel(self.root)
        select_window.title("تسجيل حضور دورات")
        select_window.geometry("800x600")
        select_window.configure(bg=self.colors["light"])
        select_window.transient(self.root)
        select_window.grab_set()

        x = (select_window.winfo_screenwidth() - 800) // 2
        y = (select_window.winfo_screenheight() - 600) // 2
        select_window.geometry(f"800x600+{x}+{y}")

        # عنوان النافذة
        title_label = tk.Label(
            select_window,
            text="تسجيل حضور دورات",
            font=self.fonts["title"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=10
        )
        title_label.pack(fill=tk.X)

        # إطار البحث مع زر التراجع
        search_frame = tk.Frame(select_window, bg=self.colors["light"], padx=10, pady=10)
        search_frame.pack(fill=tk.X)

        tk.Label(
            search_frame,
            text="بحث عن دورة:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        ).pack(side=tk.RIGHT, padx=5)

        search_var = tk.StringVar()
        search_entry = tk.Entry(
            search_frame,
            textvariable=search_var,
            font=self.fonts["text"],
            width=30
        )
        search_entry.pack(side=tk.RIGHT, padx=5)

        # إضافة زر التراجع عن آخر تسجيل دورة
        undo_course_button = tk.Button(
            search_frame,
            text="↶ تراجع عن آخر دورة",
            font=self.fonts["text"],
            bg="#FF9800",  # لون برتقالي
            fg="white",
            padx=10,
            pady=3,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self.undo_last_course_attendance(select_window)
        )
        undo_course_button.pack(side=tk.RIGHT, padx=10)

        # الحصول على قائمة الدورات الحالية
        cursor = self.conn.cursor()
        cursor.execute("SELECT DISTINCT course FROM trainees WHERE is_excluded=0 ORDER BY course")
        courses = [row[0] for row in cursor.fetchall() if row[0]]

        # قائمة الدورات مع إمكانية التمرير
        courses_frame = tk.Frame(select_window, bg=self.colors["light"], padx=10, pady=10)
        courses_frame.pack(fill=tk.BOTH, expand=True)

        courses_label = tk.Label(
            courses_frame,
            text="حدد الدورات المطلوبة:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"],
            anchor=tk.W
        )
        courses_label.pack(fill=tk.X, pady=(0, 5))

        # إطار لعرض قائمة الدورات مع شريط تمرير
        list_frame = tk.Frame(courses_frame, bg=self.colors["light"])
        list_frame.pack(fill=tk.BOTH, expand=True)

        scrollbar = tk.Scrollbar(list_frame)
        scrollbar.pack(side=tk.LEFT, fill=tk.Y)

        courses_listbox = tk.Listbox(
            list_frame,
            font=self.fonts["text"],
            selectmode=tk.MULTIPLE,  # السماح بتحديد متعدد
            yscrollcommand=scrollbar.set
        )
        courses_listbox.pack(fill=tk.BOTH, expand=True, side=tk.LEFT)
        scrollbar.config(command=courses_listbox.yview)

        # إضافة الدورات إلى القائمة
        for course in courses:
            courses_listbox.insert(tk.END, course)

        # متغير لتخزين الدورات المحددة
        selected_courses = []

        # دالة تحديث الدورات المعروضة حسب البحث
        def update_courses(*args):
            search_text = search_var.get().strip()
            courses_listbox.delete(0, tk.END)
            for course in courses:
                if search_text.lower() in course.lower():
                    courses_listbox.insert(tk.END, course)

        # ربط دالة البحث بتغيير النص
        search_var.trace_add("write", update_courses)

        # إطار أزرار الحالات
        status_frame = tk.LabelFrame(
            select_window,
            text="اختر الحالة المطلوب تسجيلها",
            font=self.fonts["text_bold"],
            bg=self.colors["light"],
            fg=self.colors["dark"],
            padx=10, pady=10
        )
        status_frame.pack(fill=tk.X, padx=10, pady=10)

        # إطار الصف الأول من أزرار الحالات (بدون غائب وغائب بعذر)
        status_row1 = tk.Frame(status_frame, bg=self.colors["light"])
        status_row1.pack(fill=tk.X, pady=5)

        # إطار الصف الثاني من أزرار الحالات
        status_row2 = tk.Frame(status_frame, bg=self.colors["light"])
        status_row2.pack(fill=tk.X, pady=5)

        # دالة تسجيل الحضور للدورات المحددة مع معالجة المستقبلين المحسنة
        def register_status(status):
            # الحصول على الدورات المحددة
            selected_indices = courses_listbox.curselection()
            if not selected_indices:
                messagebox.showwarning("تنبيه", "الرجاء تحديد دورة واحدة على الأقل")
                return

            selected_courses = [courses_listbox.get(i) for i in selected_indices]

            # التأكيد قبل التسجيل
            confirm_msg = f"هل تريد تسجيل حالة '{status}' لجميع متدربين الدورات التالية:\n"
            for course in selected_courses:
                confirm_msg += f"- {course}\n"

            if not messagebox.askyesno("تأكيد", confirm_msg):
                return

            # إنشاء نافذة تقدم العملية
            progress_window = tk.Toplevel(select_window)
            progress_window.title("تسجيل الحضور")
            progress_window.geometry("450x150")
            progress_window.configure(bg=self.colors["light"])
            progress_window.transient(select_window)
            progress_window.grab_set()

            # توسيط النافذة
            x = (progress_window.winfo_screenwidth() - 450) // 2
            y = (progress_window.winfo_screenheight() - 150) // 2
            progress_window.geometry(f"450x150+{x}+{y}")

            progress_var = tk.DoubleVar()
            progress_bar = ttk.Progressbar(
                progress_window,
                variable=progress_var,
                maximum=100,
                length=400
            )
            progress_bar.pack(pady=20)

            status_label = tk.Label(
                progress_window,
                text="جاري تحضير البيانات...",
                font=self.fonts["text"],
                bg=self.colors["light"]
            )
            status_label.pack(pady=10)

            progress_window.update()

            try:
                cursor = self.conn.cursor()

                # التحقق من التاريخ السابق إذا كانت الحالة "حاضر" أو "متأخر"
                current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
                current_time = datetime.datetime.now().strftime("%H:%M:%S")

                receivers_dict = {}
                if status in ["حاضر", "متأخر"]:
                    current_date_obj = self.date_entry.get_date()
                    yesterday_date_obj = current_date_obj - datetime.timedelta(days=1)
                    yesterday_date = yesterday_date_obj.strftime("%Y-%m-%d")

                    # جمع جميع المتدربين الذين كانوا "لم يباشر" بالأمس من جميع الدورات المحددة
                    # والذين لم يتم تسجيلهم اليوم بعد أو ليس لديهم اسم مستقبل مسجل
                    all_not_started = []

                    for course_name in selected_courses:
                        cursor.execute("""
                            SELECT DISTINCT a.national_id, t.name
                            FROM attendance a
                            JOIN trainees t ON a.national_id = t.national_id
                            WHERE a.date = ? AND a.status = 'لم يباشر'
                            AND t.course = ? AND t.is_excluded = 0
                            AND NOT EXISTS (
                                SELECT 1 FROM attendance a2 
                                WHERE a2.national_id = a.national_id 
                                AND a2.date = ? 
                                AND (a2.receiver_name IS NOT NULL AND a2.receiver_name != '')
                            )
                        """, (yesterday_date, course_name, current_date))

                        for row in cursor.fetchall():
                            all_not_started.append({
                                'national_id': row[0],
                                'name': row[1]
                            })

                    # إذا وجد متدربين يحتاجون اسم مستقبل
                    if all_not_started:
                        progress_window.destroy()
                        receivers_dict = self.get_bulk_receivers_for_not_started(
                            all_not_started,
                            f"الدورات: {', '.join(selected_courses)}"
                        )

                        if receivers_dict is None:
                            return  # المستخدم ألغى العملية

                        # إعادة فتح نافذة التقدم
                        progress_window = tk.Toplevel(select_window)
                        progress_window.title("تسجيل الحضور")
                        progress_window.geometry("450x150")
                        progress_window.configure(bg=self.colors["light"])
                        progress_window.transient(select_window)
                        progress_window.grab_set()
                        x = (progress_window.winfo_screenwidth() - 450) // 2
                        y = (progress_window.winfo_screenheight() - 150) // 2
                        progress_window.geometry(f"450x150+{x}+{y}")
                        progress_var = tk.DoubleVar()
                        progress_bar = ttk.Progressbar(progress_window, variable=progress_var, maximum=100, length=400)
                        progress_bar.pack(pady=20)
                        status_label = tk.Label(progress_window, text="جاري التسجيل...", font=self.fonts["text"],
                                                bg=self.colors["light"])
                        status_label.pack(pady=10)
                        progress_window.update()

                # تهيئة متغيرات الإحصائيات
                total_students = 0
                new_registered = 0
                already_registered = 0

                # قائمة لحفظ معرفات التسجيلات الجديدة لهذه العملية
                current_operation_records = []

                # معالجة كل دورة
                for course_idx, course_name in enumerate(selected_courses):
                    # تحديث شريط التقدم
                    progress_var.set((course_idx / len(selected_courses)) * 50)
                    status_label.config(text=f"معالجة دورة: {course_name}")
                    progress_window.update()

                    # الحصول على جميع المتدربين في الدورة المحددة
                    cursor.execute("""
                        SELECT national_id, name, rank, course 
                        FROM trainees 
                        WHERE course=? AND is_excluded=0
                    """, (course_name,))
                    students = cursor.fetchall()

                    if not students:
                        continue

                    total_students += len(students)

                    # التحقق من المتدربين المسجلين مسبقًا
                    cursor.execute("""
                        SELECT a.national_id, a.status
                        FROM attendance a
                        JOIN trainees t ON a.national_id = t.national_id
                        WHERE a.date=? AND t.course=? AND t.is_excluded=0
                    """, (current_date, course_name))

                    already_registered_ids = {row[0]: row[1] for row in cursor.fetchall()}

                    # إعداد البيانات للإدخال
                    new_records = []
                    course_progress_increment = 50 / len(selected_courses)

                    for i, student in enumerate(students):
                        student_id, student_name, student_rank, student_course = student

                        # تحديث شريط التقدم للمتدربين
                        progress = 50 + (course_idx / len(selected_courses) * 50) + (
                                i / len(students) * course_progress_increment)
                        if i % 10 == 0:
                            progress_var.set(progress)
                            status_label.config(text=f"تسجيل المتدربين في دورة {course_name} ({i + 1}/{len(students)})")
                            progress_window.update()

                        # تخطي المتدربين المسجلين بالفعل
                        if student_id in already_registered_ids:
                            already_registered += 1
                            continue

                        # التحقق من وجود اسم مستقبل مسجل مسبقاً لهذا المتدرب اليوم
                        receiver_name = ""
                        if status in ["حاضر", "متأخر"]:
                            # أولاً، تحقق من وجود تسجيل سابق اليوم مع اسم مستقبل
                            cursor.execute("""
                                SELECT receiver_name 
                                FROM attendance 
                                WHERE national_id=? AND date=? AND receiver_name IS NOT NULL AND receiver_name != ''
                                LIMIT 1
                            """, (student_id, current_date))

                            existing_receiver = cursor.fetchone()
                            if existing_receiver:
                                receiver_name = existing_receiver[0]
                            else:
                                # إذا لم يكن هناك تسجيل سابق، استخدم اسم المستقبل من القاموس
                                receiver_name = receivers_dict.get(student_id, "")

                        new_records.append((
                            student_id, student_name, student_rank, student_course,
                            current_time, current_date,
                            status, status,
                            self.current_user["full_name"], "",
                            "", "", receiver_name
                        ))
                        new_registered += 1

                    # تنفيذ الإدخال الجماعي
                    if new_records:
                        for record in new_records:
                            cursor.execute("""
                                INSERT INTO attendance (
                                    national_id, name, rank, course,
                                    time, date, status, original_status,
                                    registered_by, excuse_reason,
                                    updated_by, updated_at, receiver_name
                                )
                                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                            """, record)

                            # حفظ معرف كل تسجيل
                            attendance_id = cursor.lastrowid
                            current_operation_records.append({
                                'id': attendance_id,
                                'national_id': record[0],
                                'name': record[1],
                                'course': record[3],
                                'status': status,
                                'date': current_date,
                                'time': current_time
                            })

                        self.conn.commit()

                # حفظ معلومات العملية الكاملة في سجل الجلسة
                if current_operation_records:
                    if not hasattr(self, 'session_course_attendance_history'):
                        self.session_course_attendance_history = []

                    self.session_course_attendance_history.append({
                        'courses': selected_courses.copy(),
                        'status': status,
                        'date': current_date,
                        'time': current_time,
                        'records': current_operation_records,
                        'total_registered': new_registered
                    })

                # إكمال شريط التقدم
                progress_var.set(100)
                status_label.config(text="تم التسجيل بنجاح!")
                progress_window.update()

                # إغلاق نافذة التقدم بعد ثانيتين
                progress_window.after(2000, progress_window.destroy)

                # عرض ملخص النتائج
                messagebox.showinfo(
                    "نجاح",
                    f"تم تسجيل حالة '{status}' بنجاح:\n"
                    f"- عدد الدورات: {len(selected_courses)}\n"
                    f"- إجمالي المتدربين: {total_students}\n"
                    f"- المتدربين المسجلين حديثًا: {new_registered}\n"
                    f"- المتدربين المسجلين مسبقًا: {already_registered}"
                )

                # إلغاء تحديد الدورات بدلاً من إغلاق النافذة
                courses_listbox.selection_clear(0, tk.END)

                # تحديث الإحصائيات والعرض
                self.update_statistics()
                self.update_attendance_display()

            except Exception as e:
                # إغلاق نافذة التقدم في حالة الخطأ
                try:
                    progress_window.destroy()
                except:
                    pass
                messagebox.showerror("خطأ", f"حدث خطأ أثناء تسجيل الحضور: {str(e)}")

        # أزرار الحالات (الصف الأول) - بدون غائب وغائب بعذر
        status_buttons_row1 = [
            ("حاضر", self.colors["success"]),
            ("متأخر", self.colors["late"]),
            ("لم يباشر", self.colors["not_started"]),
            ("تطبيق ميداني", self.colors["field_application"])
        ]

        # أزرار الحالات (الصف الثاني)
        status_buttons_row2 = [
            ("يوم طالب", self.colors["student_day"]),
            ("مسائية / عن بعد", self.colors["evening_remote"])
        ]

        # إنشاء أزرار الصف الأول
        for text, color in status_buttons_row1:
            btn = tk.Button(
                status_row1,
                text=text,
                font=self.fonts["text_bold"],
                bg=color,
                fg="white",
                padx=10,
                pady=8,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=lambda s=text: register_status(s)
            )
            btn.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)

        # إنشاء أزرار الصف الثاني
        for text, color in status_buttons_row2:
            btn = tk.Button(
                status_row2,
                text=text,
                font=self.fonts["text_bold"],
                bg=color,
                fg="white",
                padx=10,
                pady=8,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=lambda s=text: register_status(s)
            )
            btn.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)

        # زر الإغلاق
        close_btn = tk.Button(
            select_window,
            text="إغلاق",
            font=self.fonts["text_bold"],
            bg=self.colors["dark"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=select_window.destroy
        )
        close_btn.pack(pady=10)


    # 4. إضافة دالة التراجع عن آخر تسجيل دورة كاملة
    def undo_last_course_attendance(self, parent_window=None):
        """التراجع عن آخر عملية تسجيل حضور دورة كاملة"""

        # التحقق من وجود سجلات للتراجع عنها
        if not self.session_course_attendance_history:
            messagebox.showinfo("تنبيه", "لا توجد عمليات تسجيل دورات كاملة للتراجع عنها في هذه الجلسة")
            return

        # الحصول على آخر عملية تسجيل
        last_operation = self.session_course_attendance_history.pop()

        # التحقق من أن التسجيل في نفس اليوم الحالي
        current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
        if last_operation['date'] != current_date:
            messagebox.showwarning(
                "تنبيه",
                "لا يمكن التراجع عن تسجيلات الأيام السابقة.\n"
                "يمكن التراجع فقط عن تسجيلات اليوم الحالي في نفس الجلسة."
            )
            # إعادة السجل إلى القائمة
            self.session_course_attendance_history.append(last_operation)
            return

        # إنشاء نافذة تقدم العملية
        progress_window = tk.Toplevel(self.root)
        progress_window.title("التراجع عن تسجيل الدورات")
        progress_window.geometry("450x150")
        progress_window.configure(bg=self.colors["light"])
        progress_window.transient(self.root)
        progress_window.grab_set()

        x = (progress_window.winfo_screenwidth() - 450) // 2
        y = (progress_window.winfo_screenheight() - 150) // 2
        progress_window.geometry(f"450x150+{x}+{y}")

        tk.Label(
            progress_window,
            text="جاري التراجع عن التسجيلات...",
            font=self.fonts["text_bold"],
            bg=self.colors["light"],
            pady=10
        ).pack()

        progress_var = tk.DoubleVar()
        progress_bar = ttk.Progressbar(
            progress_window,
            variable=progress_var,
            maximum=100,
            length=400
        )
        progress_bar.pack(pady=10)

        status_label = tk.Label(
            progress_window,
            text="جاري المعالجة...",
            font=self.fonts["text"],
            bg=self.colors["light"]
        )
        status_label.pack(pady=5)

        progress_window.update()

        try:
            deleted_count = 0
            skipped_count = 0
            total_records = len(last_operation['records'])

            # حذف التسجيلات واحدة تلو الأخرى
            for i, record in enumerate(last_operation['records']):
                # تحديث شريط التقدم
                progress = (i / total_records) * 100
                progress_var.set(progress)
                status_label.config(text=f"معالجة التسجيل {i + 1} من {total_records}")
                progress_window.update()

                # التحقق من حالة التسجيل الحالية في قاعدة البيانات
                cursor = self.conn.cursor()
                cursor.execute("""
                    SELECT status, original_status, updated_by
                    FROM attendance 
                    WHERE id=?
                """, (record['id'],))

                current_record = cursor.fetchone()

                if not current_record:
                    # التسجيل غير موجود (ربما تم حذفه بطريقة أخرى)
                    skipped_count += 1
                    continue

                current_status = current_record[0]
                original_status = current_record[1]
                updated_by = current_record[2]

                # الشرط الجديد: حذف التسجيل فقط إذا كانت حالته الأصلية هي نفس الحالة المسجلة
                # وأن الحالة ليست غياب أو غياب بعذر
                if (original_status == last_operation['status'] and
                        current_status not in ['غائب', 'غائب بعذر'] and
                        updated_by == ""):  # لم يتم تعديله من قبل مستخدم آخر

                    # حذف التسجيل
                    with self.conn:
                        self.conn.execute("DELETE FROM attendance WHERE id=?", (record['id'],))
                    deleted_count += 1
                else:
                    skipped_count += 1

            # إكمال شريط التقدم
            progress_var.set(100)
            status_label.config(text="تم الانتهاء!")
            progress_window.update()

            # إغلاق نافذة التقدم
            progress_window.destroy()

            # عرض رسالة النتائج
            courses_list = "\n".join(f"- {course}" for course in last_operation['courses'])

            result_message = f"تم التراجع عن تسجيل الدورات التالية:\n{courses_list}\n\n"
            result_message += f"الحالة المسجلة: {last_operation['status']}\n"
            result_message += f"الوقت: {last_operation['time']}\n\n"
            result_message += f"النتائج:\n"
            result_message += f"- تم حذف {deleted_count} تسجيل بنجاح\n"

            if skipped_count > 0:
                result_message += f"- تم تخطي {skipped_count} تسجيل (تم تعديلها أو هي غياب/غياب بعذر)"

            messagebox.showinfo("تم التراجع", result_message)

            # تحديث الإحصائيات والعرض
            self.update_statistics()
            self.update_attendance_display()

        except Exception as e:
            try:
                progress_window.destroy()
            except:
                pass
            messagebox.showerror("خطأ", f"حدث خطأ أثناء التراجع عن التسجيلات: {str(e)}")
            # إعادة السجل إلى القائمة في حالة الخطأ
            self.session_course_attendance_history.append(last_operation)

    def dynamic_name_search(self, event):
        try:
            text = self.name_search_entry.get().strip()
            self.name_listbox.delete(0, tk.END)
            if not text:
                return
            cursor = self.conn.cursor()
            # البحث بالاسم أو برقم الهوية معًا
            cursor.execute("""
                SELECT name, national_id 
                FROM trainees 
                WHERE (name LIKE ? OR national_id LIKE ?) AND is_excluded=0
            """, ('%' + text + '%', '%' + text + '%',))

            results = cursor.fetchall()
            for row in results:
                self.name_listbox.insert(tk.END, f"{row[0]} ({row[1]})")
        except (tk.TclError, AttributeError):
            # تجاهل الخطأ إذا لم يعد العنصر موجوداً
            pass

    def on_name_select(self, event):
        selection = self.name_listbox.curselection()
        if not selection:
            return
        selected_text = self.name_listbox.get(selection[0])
        # استخراج رقم الهوية من النص المحدد (الاسم (الهوية))
        try:
            national_id = selected_text.split("(")[1].split(")")[0]
            # تخزين رقم الهوية في الحقل الخفي
            self.id_entry.delete(0, tk.END)
            self.id_entry.insert(0, national_id)
        except:
            pass  # في حال حدوث خطأ في تنسيق النص

    def setup_attendance_log_tab(self):
        """تعديل دالة إعداد تبويب سجل الحضور لجعل الأزرار مرنة"""
        table_frame = tk.LabelFrame(self.attendance_log_tab, text="سجل الحضور", font=self.fonts["subtitle"],
                                    bg=self.colors["light"], fg=self.colors["dark"], padx=10, pady=10)
        table_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        # إطار العلوي للبحث والتاريخ والتصفية
        top_controls = tk.Frame(table_frame, bg=self.colors["light"])
        top_controls.pack(fill=tk.X, pady=(5, 2))

        # الإطار السفلي للأزرار
        button_controls = tk.Frame(table_frame, bg=self.colors["light"])
        button_controls.pack(fill=tk.X, pady=(2, 5))

        # إطار إضافي لأزرار تحديد الكل واستبعاد المحددين
        self.selection_controls = tk.Frame(table_frame, bg=self.colors["light"])

        # ---------- الإطار العلوي ----------
        # إطار اليمين - التاريخ والتصفية
        right_frame = tk.Frame(top_controls, bg=self.colors["light"])
        right_frame.pack(side=tk.RIGHT, fill=tk.Y)

        tk.Label(right_frame, text="التاريخ:", font=self.fonts["text_bold"], bg=self.colors["light"]).pack(
            side=tk.RIGHT, padx=5)
        self.log_date_entry = DateEntry(
            right_frame,
            width=15,
            background=self.colors["primary"],
            foreground='white',
            borderwidth=2,
            date_pattern='yyyy-mm-dd',
            font=self.fonts["text"],
            firstweekday="sunday",
            disableddays=(5, 6)
        )
        self.log_date_entry.pack(side=tk.RIGHT, padx=5)
        self.log_date_entry.set_date(self.today)
        self.log_date_entry.bind("<<DateEntrySelected>>", lambda e: self.update_attendance_display())

        tk.Label(right_frame, text="تصفية حسب الحالة:", font=self.fonts["text"], bg=self.colors["light"]).pack(
            side=tk.RIGHT, padx=5)

        self.status_filter_var = tk.StringVar()
        self.status_filter = ttk.Combobox(
            right_frame,
            textvariable=self.status_filter_var,
            values=["الكل", "حاضر", "متأخر", "غائب", "غائب بعذر", "لم يباشر",
                    "تطبيق ميداني", "يوم طالب", "مسائية / عن بعد", "حالة وفاة", "منوم"],
            state="readonly",
            width=15,
            font=self.fonts["text"]
        )
        self.status_filter.current(0)
        self.status_filter.pack(side=tk.RIGHT, padx=5)
        self.status_filter.bind("<<ComboboxSelected>>", self.filter_attendance)

        # إطار اليسار - البحث
        left_frame = tk.Frame(top_controls, bg=self.colors["light"])
        left_frame.pack(side=tk.LEFT, fill=tk.Y)

        tk.Label(left_frame, text="بحث (الاسم/الهوية):", font=self.fonts["text"], bg=self.colors["light"]).pack(
            side=tk.LEFT, padx=5)
        self.log_search_var = tk.StringVar()
        self.log_search_entry = tk.Entry(left_frame, textvariable=self.log_search_var, font=self.fonts["text"],
                                         width=20)
        self.log_search_entry.pack(side=tk.LEFT, padx=5)
        self.log_search_entry.bind("<KeyRelease>", lambda e: self.update_attendance_display())

        # ---------- الإطار السفلي (للأزرار) ----------
        button_controls.columnconfigure(0, weight=1)
        button_controls.columnconfigure(1, weight=0)
        button_controls.columnconfigure(2, weight=0)
        button_controls.columnconfigure(3, weight=0)
        button_controls.columnconfigure(4, weight=0)
        button_controls.columnconfigure(5, weight=0)
        button_controls.columnconfigure(6, weight=0)
        button_controls.columnconfigure(7, weight=0)  # عمود جديد لزر الإفادة
        button_controls.columnconfigure(8, weight=1)

        col_index = 1

        # زر أعلى معدلات الغياب والتأخير
        top_absence_button = tk.Button(
            button_controls,
            text="أعلى معدلات الغياب والتأخير",
            font=self.fonts["text_bold"],
            bg="#673AB7",
            fg="white",
            padx=10,
            pady=3,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.show_top_absence_statistics
        )
        top_absence_button.grid(row=0, column=col_index, padx=5, pady=5, sticky="ew")
        col_index += 1

        # زر التصدير
        if self.current_user["permissions"]["can_export_data"]:
            self.export_button = tk.Button(
                button_controls,
                text="تصدير الكل",
                font=self.fonts["text_bold"],
                bg=self.colors["primary"],
                fg="white",
                padx=10,
                pady=3,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=self.export_based_on_filter
            )
            self.export_button.grid(row=0, column=col_index, padx=5, pady=5, sticky="ew")
            col_index += 1

        # زر تصدير تكميل الدورات
        completion_export_button = tk.Button(
            button_controls,
            text="تصدير تكميل الدورات",
            font=self.fonts["text_bold"],
            bg=self.colors["secondary"],
            fg="white",
            padx=10,
            pady=3,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.export_course_completion
        )
        completion_export_button.grid(row=0, column=col_index, padx=5, pady=5, sticky="ew")
        col_index += 1

        # زر التكميل الرسمي
        official_completion_button = tk.Button(
            button_controls,
            text="التكميل الرسمي",
            font=self.fonts["text_bold"],
            bg="#E91E63",
            fg="white",
            padx=10,
            pady=3,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.export_official_completion
        )
        official_completion_button.grid(row=0, column=col_index, padx=5, pady=5, sticky="ew")
        col_index += 1

        # زر إفادة الغياب والتأخير الجديد
        absence_report_button = tk.Button(
            button_controls,
            text="إفادة",
            font=self.fonts["text_bold"],
            bg="#FF6F00",  # لون برتقالي داكن مميز
            fg="white",
            padx=10,
            pady=3,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.export_absence_report
        )
        absence_report_button.grid(row=0, column=col_index, padx=5, pady=5, sticky="ew")
        col_index += 1

        # زر إعادة تعيين اليوم
        if self.current_user["permissions"]["can_reset_attendance"]:
            reset_button = tk.Button(
                button_controls,
                text="إعادة تعيين اليوم",
                font=self.fonts["text_bold"],
                bg=self.colors["dark"],
                fg="white",
                padx=5,
                pady=3,
                bd=0,
                relief=tk.FLAT,
                command=self.reset_attendance_day,
                cursor="hand2"
            )
            reset_button.grid(row=0, column=col_index, padx=5, pady=5, sticky="ew")
            col_index += 1

        # زر استبعاد المحددين
        if self.current_user["permissions"]["is_admin"]:
            self.exclude_button = tk.Button(
                button_controls,
                text="استبعاد المحددين",
                font=self.fonts["text_bold"],
                bg=self.colors["excluded"],
                fg="white",
                padx=5,
                pady=3,
                bd=0,
                relief=tk.FLAT,
                command=self.exclude_selected_students,
                cursor="hand2"
            )
            self.exclude_button.grid(row=0, column=col_index, padx=5, pady=5, sticky="ew")

        if self.current_user["permissions"]["is_admin"]:
            clean_db_button = tk.Button(
                button_controls,
                text="تنظيف قاعدة البيانات",
                font=self.fonts["text_bold"],
                bg="#FF5722",
                fg="white",
                padx=10,
                pady=3,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=self.clean_deleted_courses
            )
            clean_db_button.grid(row=0, column=col_index + 1, padx=5, pady=5, sticky="ew")

        # باقي الكود كما هو...
        # إضافة إطار أزرار التحديد
        self.selection_frame = tk.Frame(table_frame, bg=self.colors["light"], pady=5)

        self.select_all_button = tk.Button(
            self.selection_frame,
            text="تحديد الكل",
            font=self.fonts["text_bold"],
            bg="#4CAF50",
            fg="white",
            padx=10,
            pady=3,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.select_all_students
        )
        self.select_all_button.pack(side=tk.LEFT, padx=5)

        self.clear_selection_button = tk.Button(
            self.selection_frame,
            text="إلغاء تحديد الكل",
            font=self.fonts["text_bold"],
            bg="#FFA000",
            fg="white",
            padx=10,
            pady=3,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.clear_all_selection
        )
        self.clear_selection_button.pack(side=tk.LEFT, padx=5)

        self.selected_students = {}

        self.tree_scroll = tk.Scrollbar(table_frame)
        self.tree_scroll.pack(side=tk.RIGHT, fill=tk.Y)

        if self.current_user["permissions"]["can_view_edit_history"]:
            columns = (
                "checkbox", "id", "name", "rank", "course", "status",
                "absences", "late_count", "excused", "updated_by", "updated_at"
            )
        else:
            columns = (
                "checkbox", "id", "name", "rank", "course", "status",
                "absences", "late_count", "excused"
            )

        self.attendance_tree = ttk.Treeview(table_frame, columns=columns, show="headings",
                                            yscrollcommand=self.tree_scroll.set, style="Bold.Treeview")

        self.attendance_tree.column("checkbox", width=50, anchor=tk.CENTER)
        self.attendance_tree.column("id", width=150, anchor=tk.CENTER)
        self.attendance_tree.column("name", width=250, anchor=tk.CENTER)
        self.attendance_tree.column("rank", width=100, anchor=tk.CENTER)
        self.attendance_tree.column("course", width=150, anchor=tk.CENTER)
        self.attendance_tree.column("status", width=120, anchor=tk.CENTER)

        self.attendance_tree.column("absences", width=0, minwidth=0, stretch=False)
        self.attendance_tree.column("late_count", width=0, minwidth=0, stretch=False)
        self.attendance_tree.column("excused", width=0, minwidth=0, stretch=False)

        if self.current_user["permissions"]["can_view_edit_history"]:
            self.attendance_tree.column("updated_by", width=120, anchor=tk.CENTER)
            self.attendance_tree.column("updated_at", width=130, anchor=tk.CENTER)

        self.attendance_tree.heading("checkbox", text="✓")
        self.attendance_tree.heading("id", text="رقم الهوية")
        self.attendance_tree.heading("name", text="الاسم")
        self.attendance_tree.heading("rank", text="الرتبة")
        self.attendance_tree.heading("course", text="اسم الدورة")
        self.attendance_tree.heading("status", text="الحالة")
        self.attendance_tree.heading("absences", text="غياب بدون عذر")
        self.attendance_tree.heading("late_count", text="عدد مرات التأخير")
        self.attendance_tree.heading("excused", text="غياب بعذر")

        if self.current_user["permissions"]["can_view_edit_history"]:
            self.attendance_tree.heading("updated_by", text="من عدّل")
            self.attendance_tree.heading("updated_at", text="وقت آخر تعديل")

        self.attendance_tree.pack(fill=tk.BOTH, expand=True)
        self.tree_scroll.config(command=self.attendance_tree.yview)

        self.attendance_tree.bind("<ButtonRelease-1>", self.on_tree_click)

        self.attendance_tree.tag_configure("present", background="#e8f5e9")
        self.attendance_tree.tag_configure("absent", background="#ffebee")
        self.attendance_tree.tag_configure("late", background="#fff8e1")
        self.attendance_tree.tag_configure("excused", background="#e1f5fe")
        self.attendance_tree.tag_configure("not_started", background="#FFE5CC")
        self.attendance_tree.tag_configure("field_application", background="#E0E0E0")
        self.attendance_tree.tag_configure("student_day", background="#ECECEC")
        self.attendance_tree.tag_configure("evening_remote", background="#DDDDDD")
        self.attendance_tree.tag_configure("death_case", background="#E0D6F5")
        self.attendance_tree.tag_configure("hospital", background="#D4F0ED")
        self.attendance_tree.tag_configure("checked", background="#f5f5f5")

        self.attendance_tree.configure(selectmode="extended")

        if self.current_user["permissions"]["can_edit_attendance"]:
            self.attendance_tree.bind("<Double-1>", self.on_attendance_double_click)
